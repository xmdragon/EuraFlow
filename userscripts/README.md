# OZON 真实售价计算器 - Tampermonkey 用户脚本

## 功能介绍

这是一个用于 OZON 商品页面的 Tampermonkey 用户脚本，可以自动计算并显示商品的真实售价。

### 主要特性

- ✅ 自动识别绿标价（Ozon Card 价格）和黑标价（常规价格）
- ✅ 根据智能规则计算真实售价
- ✅ 醒目的可视化显示（橙色背景高亮）
- ✅ 实时监听页格变化，自动更新
- ✅ 支持货币检测（卢布/人民币）
- ✅ 静默失败处理，不影响原页面

## 安装步骤

### 1. 安装 Tampermonkey 浏览器扩展

根据您使用的浏览器，点击对应链接安装：

- **Chrome/Edge**: [Tampermonkey - Chrome Web Store](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo)
- **Firefox**: [Tampermonkey - Firefox Add-ons](https://addons.mozilla.org/en-US/firefox/addon/tampermonkey/)
- **Safari**: [Tampermonkey - App Store](https://apps.apple.com/us/app/tampermonkey/id1482490089)

### 2. 安装脚本

1. 点击浏览器工具栏中的 Tampermonkey 图标
2. 选择"管理面板"
3. 点击"+"图标（新建脚本）
4. 删除默认内容
5. 复制 `ozon-real-price-calculator.user.js` 的完整内容
6. 粘贴到编辑器中
7. 点击"文件" → "保存"（或按 Ctrl+S / Cmd+S）

### 3. 使用脚本

1. 访问任意 OZON 商品页面：`https://www.ozon.ru/product/*`
2. 脚本会自动运行，在价格区域上方显示真实售价
3. 当页面内容变化时（如切换规格、货币），真实售价会自动更新

## 计算规则说明

### 价格识别

脚本会自动识别以下价格：

- **绿标价**：Ozon Card 会员价（带绿色标签的价格）
- **黑标价**：普通价格（未登录或非会员看到的价格）
- **划线价**：原价（用于参考，不参与计算）

### 真实售价计算公式（按优先级）

1. **货币检查**：如果当前货币是卢布（₽）→ 显示"⚠️ 请切换货币为CNY"

2. **低价商品**（黑标价 < 90 ¥）
   ```
   真实售价 = 黑标价
   ```

3. **中价商品**（黑标价在 90-120 ¥ 之间）
   ```
   真实售价 = 黑标价 + 5
   ```

4. **高价商品**（黑标价 > 120 ¥，且有绿标价）
   ```
   真实售价 = ceil((黑标价 - 绿标价) × 2.5 + 黑标价)
   ```

5. **仅有黑标价**（无绿标价时）
   ```
   真实售价 = 黑标价
   ```

### 计算示例

#### 示例 1：三个价格（高价商品）
```
绿标价：1,219 ¥（Ozon Card 价格）
黑标价：1,258 ¥（普通价格）
划线价：1,939 ¥（原价）

计算：ceil((1258 - 1219) × 2.5 + 1258)
     = ceil(39 × 2.5 + 1258)
     = ceil(97.5 + 1258)
     = ceil(1355.5)
     = 1,356 ¥

显示：真实售价：1356.00 ¥
```

#### 示例 2：低价商品
```
绿标价：69.02 ¥
黑标价：85.00 ¥

因为黑标价 < 90 ¥，直接使用简化规则
显示：真实售价：85.00 ¥
```

#### 示例 3：中价商品
```
绿标价：89.00 ¥
黑标价：95.00 ¥

因为黑标价在 90-120 区间，使用简化规则
计算：95 + 5 = 100
显示：真实售价：100.00 ¥
```

#### 示例 4：卢布货币
```
黑标价：1,258 ₽

显示：⚠️ 请切换货币为CNY
```

## 显示效果

脚本会在商品价格区域上方注入一个醒目的提示框：

```
┌─────────────────────────────────┐
│ 真实售价：1356.00 ¥             │  ← 橙色背景
└─────────────────────────────────┘
```

### 样式特性
- 🟠 **背景色**：浅橙色 (#FFE7BA)
- 🟧 **左侧边框**：深橙色竖线 (#FF9800)
- 🔴 **文字颜色**：深橙红 (#D84315)
- 📏 **字体大小**：18px 加粗
- 🎨 **圆角**：8px

## 动态更新机制

脚本使用 `MutationObserver` 监听页面变化，在以下情况会自动重新计算：

- ✅ 用户切换商品规格（如颜色、尺寸）
- ✅ 用户切换货币（₽ ↔ ¥）
- ✅ 页面动态加载新价格
- ✅ OZON 页面异步更新价格

更新采用 **500ms 防抖机制**，避免频繁计算影响性能。

## 控制台日志

脚本会在浏览器控制台输出调试信息（按 F12 查看）：

```
[OZON真实售价] 脚本初始化...
[OZON真实售价] 价格信息: {greenPrice: 1219, blackPrice: 1258, currency: "¥"}
[OZON真实售价] 计算结果: {price: 1356, message: "真实售价：1356.00 ¥"}
[OZON真实售价] 显示元素已注入
[OZON真实售价] 动态监听已启动
[OZON真实售价] 脚本已启动
```

## 故障排除

### 问题 1：脚本未运行
**解决方案**：
1. 检查 Tampermonkey 扩展是否已启用
2. 确认脚本在管理面板中是"启用"状态
3. 刷新商品页面（Ctrl+R / Cmd+R）

### 问题 2：未显示真实售价
**可能原因**：
- 货币是卢布（₽）→ 会显示提示切换货币
- 页面未完全加载 → 等待几秒
- OZON 页面结构变化 → 联系脚本维护者更新

**检查方法**：
1. 按 F12 打开开发者工具
2. 切换到"Console"标签
3. 查看是否有 `[OZON真实售价]` 开头的日志
4. 查看日志中的价格信息是否正确解析

### 问题 3：价格计算不准确
**检查步骤**：
1. 确认页面货币是人民币（¥）而非卢布（₽）
2. 打开控制台查看解析的价格值
3. 手动验证计算公式：
   - 黑标价 < 90 → 应等于黑标价
   - 黑标价 90-120 → 应等于黑标价+5
   - 黑标价 > 120 → 检查公式：ceil((黑-绿)×2.5+黑)

### 问题 4：页面变化后未更新
**解决方案**：
- 正常情况下会自动更新（500ms 延迟）
- 如果未更新，尝试刷新页面

## 技术细节

### 核心技术
- **JavaScript ES6+**
- **DOM Manipulation API**
- **MutationObserver API**
- **Tampermonkey GM API**

### 兼容性
- ✅ Chrome 88+
- ✅ Firefox 78+
- ✅ Edge 88+
- ✅ Safari 14+

### 性能优化
- **防抖处理**：避免频繁计算
- **精准选择器**：快速定位元素
- **静默失败**：不阻塞页面加载
- **轻量级**：无外部依赖，代码约 400 行

## 版本历史

### v1.0.0 (2025-10-24)
- ✨ 初始版本发布
- ✨ 支持三种价格场景识别
- ✨ 实现智能计算规则
- ✨ 添加动态监听功能
- ✨ 醒目可视化显示

## 常见问题 FAQ

**Q: 脚本会收集我的数据吗？**
A: 不会。脚本完全在本地运行，不会向任何服务器发送数据。

**Q: 为什么要切换为人民币（¥）？**
A: 计算公式基于人民币价格设计。卢布价格波动较大且汇率影响计算准确性。

**Q: 真实售价是什么意思？**
A: 这是基于 OZON 平台价格策略估算的实际成交价，考虑了会员折扣、平台佣金等因素。

**Q: 可以自定义计算公式吗？**
A: 可以。修改脚本中的 `CONFIG` 对象来调整阈值和系数。

**Q: 支持移动端吗？**
A: 支持，但需要使用支持用户脚本的移动浏览器（如 Kiwi Browser + Tampermonkey）。

## 联系方式

- 📧 **项目**: EuraFlow 跨境电商管理平台
- 📂 **文件位置**: `userscripts/ozon-real-price-calculator.user.js`
- 🐛 **问题反馈**: 通过 GitHub Issues 提交

## 许可证

本脚本为 EuraFlow 项目的一部分，遵循项目许可证。

---

**注意**：本脚本仅供学习和个人使用，计算结果仅供参考。实际价格请以 OZON 平台最终结算价格为准。
