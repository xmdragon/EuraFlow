# PRD - OZON 取消和退货申请管理

**文档版本**：v1.0
**创建日期**：2025-11-19
**产品经理**：Claude (EuraFlow PM)
**状态**：待评审

---

## 1. 背景与目标

### 1.1 需求背景

当前 EuraFlow 系统已实现 OZON 订单的全流程管理（从下单到发货），但缺少对**取消申请**和**退货申请**的管理能力。这导致：

1. **财务对账困难**：无法准确统计取消/退货导致的退款金额，影响成本分析
2. **客户投诉响应慢**：客服无法快速查看取消/退货申请状态，影响处理效率
3. **数据完整性缺失**：订单生命周期不完整，缺少售后环节的数据闭环

### 1.2 目标用户

- **财务人员**：需要统计取消/退货数据，进行对账和成本分析
- **客服人员**：需要查看取消/退货申请状态，响应客户咨询
- **运营人员**：需要监控取消率/退货率，优化商品和服务质量

### 1.3 业务价值

| 价值项 | 量化指标 |
|--------|----------|
| **财务对账效率** | 减少 50% 人工对账时间 |
| **客服响应速度** | 取消/退货查询时间从 5 分钟降至 10 秒 |
| **数据完整性** | 覆盖订单全生命周期（下单 → 发货 → 签收 → 售后）|

### 1.4 成功指标

- ✅ 用户可在 10 秒内查询到任意取消/退货申请
- ✅ 数据与 OZON 平台实时同步（延迟 < 1 小时）
- ✅ 财务对账准确率达到 99.9%

---

## 2. 功能需求

### 2.1 核心功能

#### 功能 1：取消申请列表

**描述**：展示所有 OZON FBS 取消申请，支持筛选、搜索和查看详情。

**详细说明**：
- 以列表形式展示取消申请，包含：
  - 货件编号（可点击跳转订单详情、可复制）
  - 订单日期
  - 取消日期
  - 发起人（CLIENT/SELLER/OZON/SYSTEM/DELIVERY）
  - 取消原因
  - 状态（ALL/ON_APPROVAL/APPROVED/REJECTED）
  - 自动确认日期
- 支持筛选条件：
  - 店铺选择（多店铺场景）
  - 日期范围（默认最近 30 天）
  - 状态筛选
  - 发起人筛选
- 支持搜索：
  - 按货件编号搜索
- 无限滚动加载（每页 50 条）
- 默认按取消日期降序排列

#### 功能 2：退货申请列表

**描述**：展示所有 OZON FBS 退货申请，支持筛选、搜索和查看详情。

**详细说明**：
- 以列表形式展示退货申请，包含：
  - 退货申请编号（可复制）
  - 货件编号（可点击跳转订单详情、可复制）
  - 订单号
  - 客户姓名
  - 商品信息（名称、SKU、Offer ID）
  - 退货金额（RUB）
  - 状态组（ALL/ON_APPROVAL/WAITING_FOR_RECEIVE/RECEIVED/REJECTED/REFUNDED）
  - 退款状态
  - 创建日期
- 支持筛选条件：
  - 店铺选择
  - 日期范围（默认最近 30 天）
  - 状态组筛选
- 支持搜索：
  - 按货件编号搜索
  - 按退货申请编号搜索
  - 按 Offer ID 搜索
- 无限滚动加载（每页 50 条）
- 默认按创建日期降序排列

#### 功能 3：定时数据同步

**描述**：自动从 OZON 平台同步取消和退货申请数据。

**详细说明**：
- 每小时自动同步一次（Cron: `0 */1 * * *`）
- 增量同步策略：使用 `last_id` 获取新增申请
- 去重逻辑：使用 `cancellation_id` / `return_id` 作为唯一标识
- 支持手动触发同步（点击"刷新"按钮）
- 同步进度实时显示（进度条 + 通知）

#### 功能 4：状态实时跟踪

**描述**：实时展示取消/退货申请的最新状态，与 OZON 平台保持一致。

**详细说明**：
- 状态使用 Tag 组件高亮显示
- 不同状态使用不同颜色：
  - `ON_APPROVAL`（待审核）：橙色
  - `APPROVED`（已同意）：绿色
  - `REJECTED`（已拒绝）：红色
  - `REFUNDED`（已退款）：蓝色
- 悬停显示状态详细说明

---

### 2.2 用户故事

| 角色 | 故事 | 验收标准 |
|------|------|----------|
| **财务人员** | 作为财务人员，我想查看本月所有退货申请的退款金额，以便进行财务对账 | 可按日期范围筛选，显示退款金额总计 |
| **客服人员** | 作为客服人员，我想通过货件编号快速查询取消申请状态，以便回复客户咨询 | 输入货件编号后 10 秒内返回结果 |
| **运营人员** | 作为运营人员，我想查看本周的取消率，以便评估商品质量 | 显示本周取消申请数量和占比 |
| **管理员** | 作为管理员，我想确保数据与 OZON 平台同步，以便数据准确性 | 每小时自动同步，延迟 < 1 小时 |

---

### 2.3 业务规则

#### 规则 1：数据同步频率
- **定时同步**：每小时同步一次（UTC 时间整点）
- **手动同步**：用户点击"刷新"按钮触发
- **同步范围**：最近 90 天的申请（超过 90 天的数据归档）

#### 规则 2：权限控制
- **admin**：可查看所有店铺的取消/退货申请
- **operator**：只能查看已授权店铺的申请
- **viewer**：只读权限，无法触发同步

#### 规则 3：数据去重
- 使用 `cancellation_id` 和 `return_id` 作为唯一标识
- 同一申请多次同步时，更新而非新增记录

#### 规则 4：时间处理
- **存储**：数据库一律使用 UTC 时间
- **显示**：根据用户系统设置的时区自动转换
- **查询**：前端传参时转换为 UTC

#### 规则 5：金额处理
- **存储**：使用 `Decimal(18, 4)` 存储金额
- **显示**：根据货币代码格式化（如 RUB → ₽1,234.56）

---

## 3. 非功能需求

### 3.1 性能要求
- **API 响应时间**：P95 < 500ms，P99 < 1s
- **数据库查询次数**：单次请求 ≤ 10 次查询（避免 N+1 问题）
- **并发能力**：支持 100 QPS（多店铺场景）
- **数据加载**：首屏加载时间 < 2s

### 3.2 可用性要求
- **SLA**：99.9% 可用性（每月停机时间 < 44 分钟）
- **容错性**：OZON API 失败时自动重试（最多 5 次，指数退避）
- **降级策略**：API 不可用时显示缓存数据（标注过期时间）

### 3.3 安全要求
- **权限校验**：后端强制校验 `filter_by_shop_permission`
- **数据脱敏**：客户姓名脱敏显示（如 "张**"）
- **日志脱敏**：电话、邮箱、地址不记录日志

### 3.4 兼容性要求
- **向后兼容**：不影响现有订单管理功能
- **API 版本**：遵循 `/api/ef/v1/*` 规范
- **浏览器支持**：Chrome 90+、Firefox 88+、Safari 14+

---

## 4. 技术方案

### 4.1 架构设计

```
┌─────────────┐
│   前端页面   │  CancelReturn.tsx（双 Tab 页）
│ /cancel-return │
└──────┬──────┘
       │ HTTP GET/POST
       ↓
┌─────────────────────────┐
│   API 路由层            │  cancel_return_routes.py
│ /api/ef/v1/ozon/*       │  - 权限校验
└──────┬──────────────────┘  - 参数验证
       │
       ↓
┌─────────────────────────┐
│   服务层                │  CancelReturnService
│ cancel_return_service.py │  - sync_cancellations()
└──────┬──────────────────┘  - sync_returns()
       │                      - get_cancellation_list()
       ↓
┌─────────────────────────┐
│   数据访问层            │  OzonCancellation
│ models/cancel_return.py  │  OzonReturn
└──────┬──────────────────┘
       │
       ↓
┌─────────────────────────┐
│   PostgreSQL 数据库      │  ozon_cancellations
└─────────────────────────┘  ozon_returns

┌─────────────────────────┐
│   定时任务              │  Celery Beat
│ cancel_return_sync.py   │  - 每小时同步
└─────────────────────────┘
```

---

### 4.2 数据模型设计

#### 表 1：ozon_cancellations（取消申请表）

```sql
CREATE TABLE ozon_cancellations (
    -- 主键
    id BIGSERIAL PRIMARY KEY,

    -- 店铺隔离
    shop_id INTEGER NOT NULL,

    -- 关联关系
    posting_id BIGINT REFERENCES ozon_postings(id),
    order_id BIGINT REFERENCES ozon_orders(id),

    -- OZON 字段
    cancellation_id BIGINT NOT NULL UNIQUE COMMENT 'OZON取消申请ID',
    posting_number VARCHAR(100) NOT NULL COMMENT '货件编号',

    -- 状态信息
    state VARCHAR(50) NOT NULL COMMENT '状态：ALL/ON_APPROVAL/APPROVED/REJECTED',
    state_name VARCHAR(200) COMMENT '状态名称',

    -- 取消信息
    cancellation_initiator VARCHAR(50) COMMENT '发起人：CLIENT/SELLER/OZON/SYSTEM/DELIVERY',
    cancellation_reason_id INTEGER COMMENT '取消原因ID',
    cancellation_reason_name VARCHAR(500) COMMENT '取消原因名称',
    cancellation_reason_message TEXT COMMENT '取消备注（发起人填写）',

    -- 审批信息
    approve_comment TEXT COMMENT '确认/拒绝备注',
    approve_date TIMESTAMPTZ COMMENT '确认/拒绝日期',
    auto_approve_date TIMESTAMPTZ COMMENT '自动确认日期',

    -- 时间信息
    order_date TIMESTAMPTZ NOT NULL COMMENT '订单创建日期',
    cancelled_at TIMESTAMPTZ NOT NULL COMMENT '取消申请创建日期',

    -- 原始数据
    raw_payload JSONB COMMENT 'OZON原始数据',

    -- 时间戳
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),

    -- 约束和索引
    CONSTRAINT uq_ozon_cancellations_shop_id UNIQUE (shop_id, cancellation_id)
);

CREATE INDEX idx_ozon_cancellations_shop_state ON ozon_cancellations(shop_id, state);
CREATE INDEX idx_ozon_cancellations_shop_date ON ozon_cancellations(shop_id, cancelled_at);
CREATE INDEX idx_ozon_cancellations_posting ON ozon_cancellations(posting_number);
```

#### 表 2：ozon_returns（退货申请表）

```sql
CREATE TABLE ozon_returns (
    -- 主键
    id BIGSERIAL PRIMARY KEY,

    -- 店铺隔离
    shop_id INTEGER NOT NULL,

    -- 关联关系
    posting_id BIGINT REFERENCES ozon_postings(id),
    order_id BIGINT REFERENCES ozon_orders(id),

    -- OZON 字段
    return_id BIGINT NOT NULL UNIQUE COMMENT 'OZON退货申请ID',
    return_number VARCHAR(100) NOT NULL COMMENT '退货申请编号',
    posting_number VARCHAR(100) NOT NULL COMMENT '货件编号',
    order_number VARCHAR(100) COMMENT '订单号',

    -- 客户信息
    client_name VARCHAR(200) COMMENT '买家姓名',

    -- 商品信息
    product_name VARCHAR(500) COMMENT '商品名称',
    offer_id VARCHAR(100) COMMENT '商品货号',
    sku BIGINT COMMENT 'SKU',
    price DECIMAL(18, 4) COMMENT '价格',
    currency_code VARCHAR(10) COMMENT '货币代码',

    -- 状态信息
    group_state VARCHAR(50) NOT NULL COMMENT '状态组',
    state VARCHAR(50) NOT NULL COMMENT '状态标识',
    state_name VARCHAR(200) COMMENT '状态名称',
    money_return_state_name VARCHAR(200) COMMENT '退款状态名称',

    -- 时间信息
    created_at_ozon TIMESTAMPTZ NOT NULL COMMENT 'OZON创建日期',

    -- 原始数据
    raw_payload JSONB COMMENT 'OZON原始数据',

    -- 时间戳
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),

    -- 约束和索引
    CONSTRAINT uq_ozon_returns_shop_id UNIQUE (shop_id, return_id)
);

CREATE INDEX idx_ozon_returns_shop_state ON ozon_returns(shop_id, group_state);
CREATE INDEX idx_ozon_returns_shop_date ON ozon_returns(shop_id, created_at_ozon);
CREATE INDEX idx_ozon_returns_posting ON ozon_returns(posting_number);
CREATE INDEX idx_ozon_returns_offer ON ozon_returns(offer_id);
```

---

### 4.3 API 设计

#### 接口 1：获取取消申请列表

**端点**：`GET /api/ef/v1/ozon/cancellations`

**请求参数**：
```json
{
  "page": 1,
  "limit": 50,
  "shop_id": 1,
  "state": "ON_APPROVAL",
  "initiator": "CLIENT",
  "posting_number": "12345-6789",
  "date_from": "2025-11-01T00:00:00Z",
  "date_to": "2025-11-19T23:59:59Z"
}
```

**响应体**：
```json
{
  "ok": true,
  "data": {
    "items": [
      {
        "id": 1,
        "cancellation_id": 123456,
        "posting_number": "12345-6789-0001",
        "order_date": "2025-11-15T10:30:00Z",
        "cancelled_at": "2025-11-16T08:20:00Z",
        "cancellation_initiator": "CLIENT",
        "cancellation_reason_name": "客户改变主意",
        "state": "ON_APPROVAL",
        "state_name": "待审核",
        "auto_approve_date": "2025-11-18T08:20:00Z"
      }
    ],
    "total": 156,
    "page": 1,
    "limit": 50
  }
}
```

---

#### 接口 2：手动同步取消申请

**端点**：`POST /api/ef/v1/ozon/cancellations/sync`

**请求体**：
```json
{
  "shop_id": 1
}
```

**响应体**：
```json
{
  "ok": true,
  "data": {
    "task_id": "abc123",
    "message": "取消申请同步任务已启动"
  }
}
```

---

#### 接口 3：获取退货申请列表

**端点**：`GET /api/ef/v1/ozon/returns`

**请求参数**：
```json
{
  "page": 1,
  "limit": 50,
  "shop_id": 1,
  "group_state": "ON_APPROVAL",
  "posting_number": "12345-6789",
  "offer_id": "PROD-001",
  "date_from": "2025-11-01T00:00:00Z",
  "date_to": "2025-11-19T23:59:59Z"
}
```

**响应体**：
```json
{
  "ok": true,
  "data": {
    "items": [
      {
        "id": 1,
        "return_id": 789012,
        "return_number": "RET-2025-001",
        "posting_number": "12345-6789-0001",
        "client_name": "张**",
        "product_name": "示例商品",
        "offer_id": "PROD-001",
        "sku": 123456,
        "price": "1299.99",
        "currency_code": "RUB",
        "group_state": "ON_APPROVAL",
        "state_name": "待审核",
        "money_return_state_name": "等待退款",
        "created_at_ozon": "2025-11-17T14:30:00Z"
      }
    ],
    "total": 89,
    "page": 1,
    "limit": 50
  }
}
```

---

### 4.4 服务层设计

**服务类**：`CancelReturnService`（路径：`plugins/ef/channels/ozon/services/cancel_return_service.py`）

**核心方法**：

```python
class CancelReturnService:
    """取消和退货申请服务"""

    async def sync_cancellations(self, shop_id: int, last_id: int = 0) -> dict:
        """
        同步取消申请

        Args:
            shop_id: 店铺ID
            last_id: 上次同步的 last_id（增量同步）

        Returns:
            同步结果：{"synced": 10, "updated": 2, "last_id": 12345}
        """
        pass

    async def sync_returns(self, shop_id: int, last_id: int = 0) -> dict:
        """同步退货申请"""
        pass

    async def get_cancellation_list(
        self,
        shop_id: Optional[int],
        page: int,
        limit: int,
        filters: dict
    ) -> dict:
        """
        获取取消申请列表

        Args:
            shop_id: 店铺ID（None 表示所有店铺）
            page: 页码
            limit: 每页数量
            filters: 筛选条件（state/initiator/posting_number/date_from/date_to）

        Returns:
            分页数据：{"items": [...], "total": 156, "page": 1, "limit": 50}
        """
        pass

    async def get_return_list(
        self,
        shop_id: Optional[int],
        page: int,
        limit: int,
        filters: dict
    ) -> dict:
        """获取退货申请列表"""
        pass
```

---

### 4.5 前端设计

**页面路由**：`/dashboard/ozon/cancel-return`

**组件文件**：`web/src/pages/ozon/CancelReturn.tsx`

**组件结构**：

```typescript
<PageLayout>
  <PageTitle icon={<CloseCircleOutlined />} title="取消和退货申请" />

  {/* 筛选器 */}
  <Card>
    <Row gutter={16}>
      <Col>
        <ShopSelectorWithLabel
          value={selectedShop}
          onChange={setSelectedShop}
        />
      </Col>
      <Col>
        <DateRangePicker
          value={dateRange}
          onChange={setDateRange}
        />
      </Col>
      <Col>
        <Input.Search
          placeholder="搜索货件编号"
          onSearch={handleSearch}
        />
      </Col>
    </Row>
  </Card>

  {/* 双 Tab 页 */}
  <Tabs defaultActiveKey="cancellations">
    {/* Tab 1: 取消申请列表 */}
    <TabPane tab={`取消申请 (${cancellationCount})`} key="cancellations">
      <Table
        dataSource={cancellations}
        columns={cancellationColumns}
        loading={isLoadingCancellations}
        scroll={{ y: 600 }}
        onScroll={handleScroll}  {/* 无限滚动 */}
      />
    </TabPane>

    {/* Tab 2: 退货申请列表 */}
    <TabPane tab={`退货申请 (${returnCount})`} key="returns">
      <Table
        dataSource={returns}
        columns={returnColumns}
        loading={isLoadingReturns}
        scroll={{ y: 600 }}
        onScroll={handleScroll}
      />
    </TabPane>
  </Tabs>
</PageLayout>
```

**复用组件**：
- `ShopSelectorWithLabel` - 店铺选择器（COMPONENTS.md）
- `PageTitle` - 页面标题组件
- `useDateTime` - 时间格式化 Hook
- `useCopy` - 复制功能 Hook
- `useAsyncTaskPolling` - 异步任务轮询 Hook

**状态管理**：使用 TanStack Query

```typescript
const { data: cancellations, isLoading } = useQuery({
  queryKey: ['cancellations', page, limit, filters],
  queryFn: () => ozonApi.getCancellations({ page, limit, ...filters }),
});
```

---

### 4.6 异步任务设计

**任务 1：取消申请同步**

- **任务名称**：`ef.ozon.cancellations.sync`
- **触发方式**：定时触发（Celery Beat）
- **Cron 表达式**：`0 */1 * * *`（每小时整点执行，UTC）
- **任务逻辑**：
  1. 获取所有已配置的店铺
  2. 遍历每个店铺，调用 OZON API 获取取消申请列表
  3. 去重后插入/更新数据库
  4. 记录同步日志（OzonSyncLog）

**任务 2：退货申请同步**

- **任务名称**：`ef.ozon.returns.sync`
- **触发方式**：定时触发（Celery Beat）
- **Cron 表达式**：`0 */1 * * *`（每小时整点执行，UTC）
- **任务逻辑**：同上

---

## 5. 可观测性设计

### 5.1 日志

**日志级别**：
- `INFO`：正常流程（同步开始/完成、查询请求）
- `WARNING`：非致命错误（API 超时重试、数据格式异常）
- `ERROR`：致命错误（API 调用失败、数据库异常）

**日志字段**（JSON 格式）：
```json
{
  "timestamp": "2025-11-19T10:30:00Z",
  "level": "INFO",
  "logger": "ozon.cancel_return",
  "message": "取消申请同步完成",
  "context": {
    "shop_id": 1,
    "synced": 10,
    "updated": 2,
    "duration_ms": 2350
  }
}
```

**脱敏规则**：
- 客户姓名：`张三` → `张**`
- 电话/邮箱：不记录日志

---

### 5.2 指标

| 指标名称 | 类型 | 说明 |
|----------|------|------|
| `ef_ozon_cancellations_sync_total` | Counter | 取消申请同步次数 |
| `ef_ozon_cancellations_sync_latency_ms` | Histogram | 取消申请同步耗时（ms）|
| `ef_ozon_cancellations_sync_errors_total` | Counter | 取消申请同步失败次数 |
| `ef_ozon_returns_sync_total` | Counter | 退货申请同步次数 |
| `ef_ozon_returns_sync_latency_ms` | Histogram | 退货申请同步耗时（ms）|
| `ef_ozon_api_requests_total` | Counter | OZON API 请求次数（按端点分组）|
| `ef_ozon_api_errors_total` | Counter | OZON API 错误次数（按错误码分组）|

---

### 5.3 告警

| 告警名称 | 条件 | 通知方式 |
|----------|------|----------|
| **同步任务失败** | 连续 3 次同步失败 | 钉钉/邮件 |
| **API 错误率高** | 错误率 > 5%（5 分钟内）| 钉钉 |
| **响应时间慢** | P95 响应时间 > 1s | Slack |
| **数据库查询慢** | 单次查询 > 3s | 日志记录 |

---

## 6. 数据库迁移

### 6.1 迁移脚本

**文件名**：`alembic/versions/xxx_add_cancel_return_tables.py`

**生成命令**：
```bash
alembic revision -m "add ozon cancellation and return tables"
```

**upgrade() 函数**：
```python
def upgrade():
    # 创建 ozon_cancellations 表
    op.create_table(
        'ozon_cancellations',
        sa.Column('id', sa.BigInteger(), primary_key=True),
        sa.Column('shop_id', sa.Integer(), nullable=False),
        # ... 其他字段
    )

    # 创建索引
    op.create_index('idx_ozon_cancellations_shop_state', 'ozon_cancellations', ['shop_id', 'state'])

    # 创建 ozon_returns 表
    op.create_table(
        'ozon_returns',
        # ...
    )
```

**downgrade() 函数**：
```python
def downgrade():
    op.drop_table('ozon_returns')
    op.drop_table('ozon_cancellations')
```

**应用迁移**：
```bash
# 本地测试
alembic upgrade head

# 生产环境（需备份）
pg_dump euraflow > backup_20251119.sql
alembic upgrade head
```

---

### 6.2 回滚方案

**场景 1：迁移失败**
```bash
# 回滚到上一个版本
alembic downgrade -1
```

**场景 2：数据异常**
```bash
# 回滚迁移
alembic downgrade -1

# 恢复备份
psql euraflow < backup_20251119.sql
```

---

## 7. 验收标准

### 7.1 功能测试

- [ ] **取消申请列表展示**：
  - 可正常展示取消申请列表
  - 数据字段完整（货件编号、日期、发起人、原因、状态）
  - 状态 Tag 颜色正确

- [ ] **退货申请列表展示**：
  - 可正常展示退货申请列表
  - 数据字段完整（退货编号、商品信息、金额、状态）
  - 客户姓名脱敏正确

- [ ] **筛选功能**：
  - 店铺筛选生效
  - 日期范围筛选生效（最近 30 天）
  - 状态筛选生效
  - 货件编号搜索生效

- [ ] **无限滚动**：
  - 滚动到底部自动加载下一页
  - 加载提示显示正常
  - 没有更多数据时显示"已加载全部"

- [ ] **定时同步**：
  - Celery Beat 定时任务正常执行
  - 同步日志记录正确
  - 数据去重逻辑生效

- [ ] **手动同步**：
  - 点击"刷新"按钮触发同步
  - 同步进度实时显示
  - 同步完成后自动刷新列表

- [ ] **权限控制**：
  - admin 可查看所有店铺数据
  - operator 只能查看已授权店铺数据
  - viewer 无法触发同步

---

### 7.2 性能测试

- [ ] **API 响应时间**：
  - P95 < 500ms
  - P99 < 1s

- [ ] **数据库查询次数**：
  - 单次请求 ≤ 10 次查询
  - 无 N+1 查询问题

- [ ] **并发测试**：
  - 100 QPS 无错误
  - CPU 使用率 < 70%
  - 内存使用率 < 80%

- [ ] **数据量测试**：
  - 10 万条数据时，查询响应时间 < 500ms
  - 无限滚动流畅（无明显卡顿）

---

### 7.3 代码质量

- [ ] **后端代码**：
  - `ruff` 检查通过
  - `mypy --strict` 通过
  - `black` 格式化通过

- [ ] **前端代码**：
  - `eslint` 检查通过
  - `tsc` 类型检查通过
  - `prettier` 格式化通过

- [ ] **测试覆盖率**：
  - 整体覆盖率 ≥ 80%
  - 核心服务层覆盖率 ≥ 90%

- [ ] **自检清单**（CLAUDE.md）：
  - [ ] 未越过不变量（API 前缀/EF__/ef_*/UTC/Decimal）
  - [ ] 改动仅在白名单文件；未新增依赖
  - [ ] 事务/会话安全（无跨线程共享、无未关闭会话）
  - [ ] 外部调用含超时+重试+幂等；无阻塞 I/O
  - [ ] 新增/变更 API 的 OpenAPI 已更新
  - [ ] 指标/日志齐全且脱敏
  - [ ] 测试覆盖关键路径
  - [ ] 回滚方案明确（DB 迁移提供 downgrade）

---

## 8. 风险与依赖

### 8.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| **OZON API 速率限制** | 同步失败，数据不及时 | 中 | 每小时同步一次，实现重试机制（最多 5 次，指数退避）|
| **数据量过大** | 查询变慢，影响用户体验 | 中 | 添加索引（shop_id + cancelled_at），限制查询范围（最近 30 天）|
| **状态不一致** | 数据错误，影响对账 | 低 | 同步时同步更新订单状态，添加一致性检查任务 |
| **OZON API 文档不完整** | 字段理解错误 | 低 | 存储 `raw_payload`，保留原始数据便于排查 |

---

### 8.2 外部依赖

| 依赖项 | SLA | 风险 | 缓解措施 |
|--------|-----|------|----------|
| **OZON API** | 未明确 | API 不可用导致同步失败 | 实现容错机制（失败重试、降级展示缓存数据）|
| **PostgreSQL** | 99.9% | 数据库不可用导致服务中断 | 使用主从复制，定期备份 |
| **Redis** | 99.9% | 缓存不可用影响性能 | 缓存失败时直接查询数据库 |
| **Celery Beat** | 99.5% | 定时任务不执行 | 监控任务执行状态，告警通知 |

---

### 8.3 阻塞因素

- ❌ **OZON API 凭证缺失**：需要 OZON 平台开通 API 权限
- ❌ **数据库容量不足**：需评估存储需求，必要时扩容
- ⚠️ **测试环境缺失**：需要 OZON 沙箱环境进行集成测试

---

## 9. 开发计划

### 9.1 任务分解

| 阶段 | 任务 | 负责人 | 预计工时 | 依赖 |
|------|------|--------|----------|------|
| **阶段 1** | 数据库设计与迁移 | 后端 | 0.5 天 | - |
| | 1.1 编写数据模型（models/cancel_return.py）| 后端 | 2 小时 | - |
| | 1.2 生成 Alembic 迁移脚本 | 后端 | 1 小时 | 1.1 |
| | 1.3 本地测试迁移（upgrade & downgrade）| 后端 | 1 小时 | 1.2 |
| **阶段 2** | 后端 API 实现 | 后端 | 1.5 天 | 阶段 1 |
| | 2.1 OZON API 客户端封装 | 后端 | 3 小时 | - |
| | 2.2 服务层实现（CancelReturnService）| 后端 | 4 小时 | 2.1 |
| | 2.3 API 路由实现（cancel_return_routes.py）| 后端 | 3 小时 | 2.2 |
| | 2.4 定时任务注册（setup.py + Celery）| 后端 | 2 小时 | 2.2 |
| **阶段 3** | 前端页面实现 | 前端 | 1.5 天 | 阶段 2 |
| | 3.1 页面组件开发（CancelReturn.tsx）| 前端 | 4 小时 | - |
| | 3.2 筛选器实现 | 前端 | 2 小时 | 3.1 |
| | 3.3 表格列设计 | 前端 | 2 小时 | 3.1 |
| | 3.4 添加菜单入口和路由注册 | 前端 | 2 小时 | 3.1 |
| **阶段 4** | 测试与优化 | QA + 开发 | 0.5 天 | 阶段 3 |
| | 4.1 单元测试（Service 层）| 后端 | 2 小时 | - |
| | 4.2 API 测试（集成测试）| QA | 1 小时 | - |
| | 4.3 前端功能测试 | QA | 1 小时 | - |
| **阶段 5** | 部署上线 | DevOps + 开发 | 0.5 天 | 阶段 4 |
| | 5.1 代码 Review | Tech Lead | 1 小时 | - |
| | 5.2 数据库迁移（生产环境）| DevOps | 1 小时 | - |
| | 5.3 远程部署 | DevOps | 1 小时 | - |
| | 5.4 验证功能正常 | QA | 1 小时 | - |

**总计**：约 **4-5 个工作日**

---

### 9.2 里程碑

| 里程碑 | 完成日期 | 验收标准 |
|--------|----------|----------|
| **M1：数据库迁移完成** | Day 1 | 迁移脚本通过测试，表结构正确 |
| **M2：后端 API 完成** | Day 2.5 | API 响应正确，单元测试通过 |
| **M3：前端页面完成** | Day 4 | 页面功能完整，UI 符合设计 |
| **M4：测试通过** | Day 4.5 | 所有测试用例通过 |
| **M5：上线** | Day 5 | 生产环境功能正常 |

---

## 10. 附录

### 10.1 参考文档

- [CLAUDE.md](../../CLAUDE.md) - EuraFlow 开发规范
- [COMPONENTS.md](../../COMPONENTS.md) - 可复用组件清单
- [FAQ.md](../../FAQ.md) - 常见问题解决方案
- [OZON API 文档](../OzonAPI/index.html) - OZON Seller API 参考

### 10.2 相关讨论

- **需求讨论**：2025-11-19（产品经理 + 用户）
- **技术方案评审**：待安排（产品经理 + 技术负责人）
- **UI 设计评审**：待安排（设计师 + 产品经理）

### 10.3 术语表

| 术语 | 说明 |
|------|------|
| **FBS** | Fulfillment by Seller（卖家自发货）|
| **取消申请** | 客户或卖家发起的订单取消请求 |
| **退货申请** | 客户发起的商品退货请求 |
| **Posting** | OZON 货件（一个订单可能包含多个 Posting）|
| **Cursor-based 分页** | 基于 `last_id` 的分页方式，避免数据重复 |

---

## 11. 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2025-11-19 | 初始版本，完成需求分析和技术方案设计 | Claude (EuraFlow PM) |

---

**PRD 结束**

📧 如有疑问，请联系产品经理进行评审和讨论。
