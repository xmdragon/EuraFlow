# PRD - 商品采集与上架流程优化

**创建日期**: 2025-11-15
**产品经理**: Claude
**版本**: v1.0

---

## 一、背景与目标

### 1.1 需求背景
当前系统中商品上架流程存在以下问题：
1. 浏览器扩展"跟卖"上架后弹出窗口，打断用户操作流程
2. 缺少采集功能，用户无法保存商品数据待后续处理
3. 上架记录缺失，无法追踪商品上架状态
4. 左侧菜单"商品上架"入口不直观，用户找不到功能

### 1.2 目标用户
- **跨境电商卖家**：使用浏览器扩展快速跟卖 OZON 商品
- **选品人员**：批量采集商品数据，分析后再上架

### 1.3 业务价值
- **提升效率**：跟卖无弹窗，操作更流畅
- **数据沉淀**：采集记录保存商品数据，支持二次编辑
- **状态追踪**：上架记录追踪全流程，便于排查问题
- **体验优化**：菜单结构更清晰，功能入口更直观

### 1.4 成功指标
- 跟卖上架成功率 ≥ 95%
- 采集记录使用率 ≥ 30%（相对跟卖次数）
- 用户反馈：操作流程更顺畅（NPS 提升 10 分）

---

## 二、功能需求

### 2.1 核心功能

#### 功能1：普通采集（不立即上架）
**描述**：用户在 OZON 商品详情页点击"采集"按钮，保存商品数据到系统，待后续编辑上架。

**前置条件**：
- 商品数据包含尺寸（长宽高）和重量
- 用户已选择店铺

**业务流程**：
1. 浏览器扩展解析 OZON 商品详情页
2. 用户点击"采集"按钮
3. **前端校验**：检查是否有尺寸和重量数据
   - 缺失 → 提示"尺寸和重量数据缺失，请刷新重试"，不发送请求
   - 完整 → 发送数据到后端 API
4. 后端保存数据到 `ozon_product_collection_records` 表
5. 返回成功，前端提示"商品已采集，请到系统采集记录中查看"
6. **窗口不关闭**，用户可以继续采集其他商品

**验收标准**：
- [ ] 缺失尺寸/重量时提示错误，不发送请求
- [ ] 采集成功后显示成功提示
- [ ] 浏览器扩展窗口不关闭

---

#### 功能2：跟卖上架（直接上架）
**描述**：用户在 OZON 商品详情页点击"跟卖"按钮，直接调用 OZON API 上架，无需人工干预。

**前置条件**：
- 商品数据完整（标题、图片、变体、价格、库存）
- 用户已选择店铺、仓库、水印

**业务流程**：
1. 用户点击"跟卖"按钮
2. 浏览器扩展发送数据到后端 API（`/collection-records/follow-pdp`）
3. 后端创建采集记录（`collection_type='follow_pdp'`, `listing_status='pending'`）
4. 后端调用 OZON API 上架（`/v1/product/import`）
5. 保存 OZON 返回的 `task_id`，更新状态为 `processing`
6. 启动 Celery 异步任务轮询上架状态
7. **前端收到成功响应后直接关闭窗口**（不弹出任何提示）
8. 用户可在"上架记录"页面查看上架进度

**验收标准**：
- [ ] 数据发送成功后直接关闭浏览器扩展窗口
- [ ] 不弹出任何成功/失败提示
- [ ] 上架记录页面显示正确的状态（pending → processing → success/failed）

---

#### 功能3：上架记录管理
**描述**：展示跟卖上架的商品记录，支持查看、编辑、重新上架、删除。

**页面位置**：左侧菜单"上架记录"

**列表字段**：
- 商品图片
- 标题（俄文 + 中文）
- 上架状态（pending/processing/success/failed）
- 创建时间
- 操作按钮

**操作功能**：
1. **查看**：展开详情，显示完整商品信息
2. **编辑**：支持修改以下字段
   - 价格、库存、仓库（简单字段）
   - 标题、描述、图片、特征值（完整数据）
   - 保存后更新 `last_edited_at` 和 `last_edited_by`
3. **重新上架**：失败的记录可重新调用 OZON API 上架
4. **删除**：软删除（设置 `is_deleted=true`）

**状态标签**：
- `pending` - 待上架（黄色 `processing` Badge）
- `processing` - 上架中（蓝色 `default` Badge）
- `success` - 已上架（绿色 `success` Badge）
- `failed` - 失败（红色 `error` Badge）

**验收标准**：
- [ ] 列表显示所有跟卖上架的记录
- [ ] 编辑功能支持修改价格、库存、标题等字段
- [ ] 重新上架功能正常工作
- [ ] 删除后记录不再显示（软删除）

---

#### 功能4：采集记录管理
**描述**：展示普通采集的商品记录，支持查看、编辑、上架、删除。

**页面位置**：左侧菜单"采集记录"

**列表字段**：
- 商品图片
- 标题（俄文 + 中文）
- 来源 URL
- 创建时间
- 操作按钮

**操作功能**：
1. **查看**：展开详情，显示完整商品信息
2. **编辑**：修改商品数据（同上架记录）
3. **上架**：点击后触发以下流程
   - 调用 API：`POST /collection-records/{id}/to-draft`
   - 后端返回转换后的草稿数据（`draft_data`）
   - 前端跳转到新建商品页（`/products/create`）
   - 自动填充表单数据（类似恢复草稿）
   - 用户可编辑后再提交上架
4. **删除**：软删除

**验收标准**：
- [ ] 列表显示所有采集的记录
- [ ] 点击"上架"后跳转到新建商品页，数据自动填充
- [ ] 编辑和删除功能正常工作

---

### 2.2 用户故事

**故事1**：快速跟卖
- **角色**：跨境电商卖家
- **操作**：在 OZON 商品详情页点击"跟卖"按钮
- **目标**：商品快速上架，不需要等待弹窗，可以继续浏览其他商品

**故事2**：批量采集后统一处理
- **角色**：选品人员
- **操作**：浏览 OZON 商品时点击"采集"按钮，批量保存商品数据
- **目标**：稍后在系统中统一编辑、定价、上架

**故事3**：追踪上架状态
- **角色**：运营人员
- **操作**：在"上架记录"页面查看跟卖商品的状态
- **目标**：了解哪些商品上架成功，哪些失败，快速定位问题

---

### 2.3 业务规则

1. **数据完整性**：
   - 采集商品必须包含尺寸（width/height/depth）和重量（weight）
   - 跟卖上架必须包含标题、图片、价格、库存

2. **用户隔离**：
   - 每个用户只能查看/编辑自己的采集记录
   - 通过 `user_id` 强制隔离

3. **店铺权限**：
   - 所有操作检查用户对 `shop_id` 的操作权限
   - 使用现有的 `usePermission` Hook

4. **软删除**：
   - 删除操作仅设置 `is_deleted=true`
   - 支持恢复（7 天内）

5. **状态追踪**：
   - 跟卖上架记录包含完整的状态流转
   - pending → processing → success/failed
   - 失败记录保存错误信息（`listing_error_message`）

---

## 三、非功能需求

### 3.1 性能要求
- API 响应时间 < 500ms（P95）
- 数据库查询次数 ≤ 10 次（避免 N+1 查询）
- 前端页面加载时间 < 2s

### 3.2 可用性要求
- 系统可用性 ≥ 99.9%
- 上架成功率 ≥ 95%（排除 OZON API 故障）

### 3.3 安全要求
- 所有 API 接口检查用户身份认证
- 店铺级别权限控制（不同用户隔离）
- 敏感数据脱敏（日志中不输出完整商品数据）

### 3.4 兼容性要求
- 向后兼容现有 API（不影响现有功能）
- 浏览器扩展支持 Chrome/Edge（Manifest V3）

---

## 四、技术方案

### 4.1 架构设计

#### 数据流转
```
浏览器扩展采集
    ↓
采集记录表 (ozon_product_collection_records)
    ├─ collection_type='collect_only' → 采集记录页面 → 编辑 → 新建商品页 → 正式商品
    └─ collection_type='follow_pdp' → 上架记录页面 → OZON API → 正式商品
```

#### 表关系
- `ozon_product_collection_records` - 采集记录（新表）
- `ozon_product_templates` - 草稿/模板（保持不变）
- `ozon_products` - 正式商品（保持不变）

**为什么不合并表？**
1. **业务用途不同**：
   - 草稿/模板 - 用户手动创建商品的准备阶段
   - 采集记录 - 从外部抓取的数据 + 跟卖上架追踪
2. **字段差异大**：
   - 草稿不需要 `listing_status`、`listing_task_id` 等上架字段
   - 采集记录不需要 `template_name`、`tags`、`used_count` 等模板字段
3. **查询场景不同**：
   - 草稿每用户只有 1 个（唯一索引约束）
   - 采集记录每用户可以有多个（逻辑冲突）
4. **性能优化**：
   - 草稿表数据量小（每用户 1 条）
   - 采集记录可能很大（批量采集），分表避免查询性能下降

---

### 4.2 数据模型设计

#### 新表：ozon_product_collection_records

```sql
CREATE TABLE ozon_product_collection_records (
    -- 主键与关联
    id BIGSERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    shop_id INTEGER REFERENCES ozon_shops(id),

    -- 采集类型（核心区分字段）
    collection_type VARCHAR(20) NOT NULL,  -- 'follow_pdp' | 'collect_only'

    -- 采集来源
    source_url TEXT NOT NULL,
    source_product_id VARCHAR(100),

    -- 商品数据（JSONB格式，包含标题、图片、规格、变体等）
    product_data JSONB NOT NULL,

    -- 跟卖上架专属字段（仅 collection_type='follow_pdp' 时使用）
    listing_request_payload JSONB,    -- 发送给 OZON API 的请求数据
    listing_task_id VARCHAR(100),     -- OZON 返回的任务 ID
    listing_status VARCHAR(50),       -- pending/processing/success/failed
    listing_product_id BIGINT,        -- 关联 ozon_products.id
    listing_error_message TEXT,
    listing_at TIMESTAMP,

    -- 状态管理
    is_read BOOLEAN DEFAULT FALSE,
    is_deleted BOOLEAN DEFAULT FALSE,  -- 软删除

    -- 用户行为记录
    last_edited_at TIMESTAMP,
    last_edited_by INTEGER REFERENCES users(id),

    -- 时间戳（UTC）
    created_at TIMESTAMP NOT NULL DEFAULT (NOW() AT TIME ZONE 'UTC'),
    updated_at TIMESTAMP NOT NULL DEFAULT (NOW() AT TIME ZONE 'UTC'),

    CONSTRAINT chk_collection_type CHECK (collection_type IN ('follow_pdp', 'collect_only'))
);

-- 索引
CREATE INDEX idx_collection_user ON ozon_product_collection_records(user_id, created_at DESC);
CREATE INDEX idx_collection_type_status ON ozon_product_collection_records(collection_type, listing_status);
CREATE INDEX idx_collection_shop ON ozon_product_collection_records(shop_id) WHERE shop_id IS NOT NULL;
```

**字段说明**：
- `collection_type`：区分跟卖（`follow_pdp`）和普通采集（`collect_only`）
- `product_data`：JSONB 格式，存储完整的商品数据（灵活扩展）
- `listing_status`：跟卖上架状态（pending → processing → success/failed）
- `listing_task_id`：OZON API 返回的任务 ID，用于轮询状态
- `listing_product_id`：上架成功后关联的正式商品 ID

---

### 4.3 API 设计

#### 接口1：普通采集
**端点**：`POST /api/ef/v1/ozon/collection-records/collect`

**请求体**：
```json
{
  "source_url": "https://www.ozon.ru/product/1234567890",
  "source_product_id": "1234567890",
  "product_data": {
    "title": "商品标题",
    "images": ["url1", "url2"],
    "price": 1000,
    "width": 10,
    "height": 20,
    "depth": 5,
    "weight": 100,
    "variants": [...]
  },
  "shop_id": 123
}
```

**前置校验**：
- 检查 `product_data` 中是否包含 `width`、`height`、`depth`、`weight`
- 缺失则返回 422 错误：
  ```json
  {
    "ok": false,
    "error": {
      "type": "about:blank",
      "title": "Validation Error",
      "status": 422,
      "detail": "尺寸和重量数据缺失，请刷新重试",
      "code": "MISSING_DIMENSIONS"
    }
  }
  ```

**响应**：
```json
{
  "ok": true,
  "data": {
    "record_id": 456,
    "message": "商品已采集，请到系统采集记录中查看"
  }
}
```

---

#### 接口2：跟卖上架
**端点**：`POST /api/ef/v1/ozon/collection-records/follow-pdp`

**请求体**：
```json
{
  "shop_id": 123,
  "source_url": "https://www.ozon.ru/product/1234567890",
  "product_data": { /* 完整商品数据 */ },
  "variants": [
    {
      "offer_id": "SKU-001",
      "price": 1000,
      "stock": 100,
      "warehouse_id": 456
    }
  ],
  "watermark_id": 789
}
```

**业务逻辑**：
1. 创建采集记录（`collection_type='follow_pdp'`, `listing_status='pending'`）
2. 调用 OZON API 上架（`/v1/product/import`）
3. 更新记录状态为 `processing`，保存 `listing_task_id`
4. 启动 Celery 异步任务轮询上架状态
5. 成功后创建正式商品记录（`ozon_products`），更新 `listing_status='success'`

**响应**：
```json
{
  "ok": true,
  "data": {
    "record_id": 789,
    "task_id": "ozon_task_12345"
  }
}
```

**前端行为**：
- 收到成功响应后直接关闭浏览器扩展窗口
- 不弹出任何提示窗口

---

#### 接口3：查询采集记录列表
**端点**：`GET /api/ef/v1/ozon/collection-records`

**查询参数**：
- `collection_type`: `follow_pdp` | `collect_only`（必需）
- `shop_id`: 店铺 ID（可选，权限控制）
- `page`: 页码（默认 1）
- `page_size`: 每页数量（默认 20）

**响应**：
```json
{
  "ok": true,
  "data": {
    "items": [
      {
        "id": 789,
        "collection_type": "follow_pdp",
        "source_url": "https://www.ozon.ru/product/1234567890",
        "product_data": { /* ... */ },
        "listing_status": "success",
        "created_at": "2025-11-15T10:30:00Z",
        "updated_at": "2025-11-15T10:35:00Z"
      }
    ],
    "total": 50,
    "page": 1,
    "page_size": 20
  }
}
```

---

#### 接口4：编辑采集记录
**端点**：`PUT /api/ef/v1/ozon/collection-records/{record_id}`

**请求体**：
```json
{
  "product_data": { /* 完整或部分商品数据 */ }
}
```

**权限校验**：
- 检查 `user_id` 是否匹配当前用户
- 检查 `shop_id` 对应店铺的操作权限

**行为记录**：
- 更新 `last_edited_at` 和 `last_edited_by`
- 写入用户行为日志（`user_action_logs` 表）

**响应**：
```json
{
  "ok": true,
  "data": {
    "record_id": 789,
    "updated_at": "2025-11-15T11:00:00Z"
  }
}
```

---

#### 接口5：从采集记录转换为草稿
**端点**：`POST /api/ef/v1/ozon/collection-records/{record_id}/to-draft`

**功能**：将采集记录数据转换为草稿格式，返回给前端

**响应**：
```json
{
  "ok": true,
  "data": {
    "draft_data": {
      "title": "商品标题",
      "title_cn": "中文名称",
      "images": ["url1", "url2"],
      "price": 1000,
      "attributes": { /* 特征值 */ },
      "variants": [ /* 变体 */ ]
    }
  }
}
```

**前端行为**：
- 跳转到 `/dashboard/ozon/products/create`
- 将 `draft_data` 自动填充到表单
- 用户可编辑后再提交上架

---

#### 接口6：删除采集记录
**端点**：`DELETE /api/ef/v1/ozon/collection-records/{record_id}`

**逻辑**：软删除（设置 `is_deleted=true`）

**响应**：
```json
{
  "ok": true,
  "data": {
    "message": "记录已删除"
  }
}
```

---

### 4.4 服务层设计

**服务类**：`CollectionRecordService`
**路径**：`plugins/ef/channels/ozon/services/collection_record_service.py`

**核心方法**：
```python
class CollectionRecordService:
    async def create_collection_record(
        self,
        user_id: int,
        collection_type: str,
        source_url: str,
        product_data: dict,
        shop_id: int | None = None
    ) -> CollectionRecord:
        """创建采集记录"""

    async def follow_pdp_listing(
        self,
        record_id: int,
        variants: list[dict],
        warehouse_id: int,
        watermark_id: int
    ) -> dict:
        """跟卖上架（调用 OZON API）"""

    async def poll_listing_status(self, record_id: int) -> None:
        """轮询上架状态（Celery 异步任务）"""

    async def convert_to_draft_data(self, record_id: int) -> dict:
        """将采集记录转换为草稿数据"""

    async def update_record(
        self,
        record_id: int,
        product_data: dict,
        user_id: int
    ) -> CollectionRecord:
        """更新采集记录"""

    async def soft_delete(self, record_id: int, user_id: int) -> None:
        """软删除采集记录"""
```

---

### 4.5 前端设计

#### 页面1：上架记录（ListingRecords.tsx）
**路径**：`web/src/pages/ozon/ListingRecords.tsx`

**UI 结构**：
```tsx
<Page title="上架记录">
  <Space>
    <ShopSelector />  {/* 店铺筛选器 */}
    <Select placeholder="上架状态" />  {/* 状态筛选 */}
  </Space>

  <Table
    dataSource={records}
    columns={[
      { title: '商品图片', render: (record) => <ProductImage /> },
      { title: '标题', dataIndex: 'product_data.title' },
      { title: '上架状态', render: (record) => <Badge status={...} /> },
      { title: '创建时间', dataIndex: 'created_at' },
      { title: '操作', render: (record) => <Space>
        <Button>查看</Button>
        <Button>编辑</Button>
        <Button>重新上架</Button>
        <Button>删除</Button>
      </Space> }
    ]}
  />

  <RecordDetailDrawer />  {/* 编辑抽屉 */}
</Page>
```

**复用组件**：
- `ShopSelector` - 店铺选择器（`web/src/components/ozon/ShopSelector.tsx`）
- `ProductImage` - 商品图片（`web/src/components/ozon/ProductImage.tsx`）

---

#### 页面2：采集记录（CollectionRecords.tsx）
**路径**：`web/src/pages/ozon/CollectionRecords.tsx`

**上架按钮逻辑**：
```typescript
const handleListing = async (recordId: number) => {
  // 1. 调用 API 获取转换后的草稿数据
  const { data } = await apiClient.post(
    `/ozon/collection-records/${recordId}/to-draft`
  );

  // 2. 跳转到新建商品页，携带数据
  navigate('/dashboard/ozon/products/create', {
    state: {
      draftData: data.draft_data,
      source: 'collection_record',
      sourceRecordId: recordId
    }
  });
};
```

---

#### 组件：编辑抽屉（RecordDetailDrawer.tsx）
**路径**：`web/src/components/ozon/RecordDetailDrawer.tsx`

**功能**：
- 复用 `ProductCreate` 页面的表单组件
- 支持编辑完整的商品数据（标题、描述、图片、特征值）
- 保存时调用 `PUT /api/ef/v1/ozon/collection-records/{id}`

---

#### 菜单调整（Dashboard.tsx）
**路径**：`web/src/pages/Dashboard.tsx`

**移除**：
```typescript
// 删除该菜单项
{
  key: "ozon-listing",
  label: "商品上架",
}
```

**新增**：
```typescript
{
  key: "ozon-listing-records",
  icon: <CloudUploadOutlined />,
  label: "上架记录",
  onClick: () => navigate("/dashboard/ozon/listing-records"),
},
{
  key: "ozon-collection-records",
  icon: <DatabaseOutlined />,
  label: "采集记录",
  onClick: () => navigate("/dashboard/ozon/collection-records"),
}
```

---

#### 商品列表页改动（ProductList.tsx）
**路径**：`web/src/pages/ozon/ProductList.tsx`

**改动**：在"新建商品"按钮后添加"商品上架"按钮

```typescript
<Space>
  <Button
    type="primary"
    icon={<PlusOutlined />}
    onClick={() => navigate('/dashboard/ozon/products/create')}
  >
    新建商品
  </Button>

  <Button
    type="default"
    icon={<CloudUploadOutlined />}
    onClick={() => navigate('/dashboard/ozon/listing-records')}
  >
    商品上架
  </Button>
</Space>
```

---

### 4.6 浏览器扩展设计

**文件**：`plugins/ef/channels/ozon/browser_extension/src/content/components/PublishModal.tsx`

#### 改动1：按钮名称调整
```typescript
// 原："一键跟卖" → 改为："跟卖"
<Button type="primary" onClick={handleFollowPdp}>
  跟卖
</Button>
```

#### 改动2：新增"采集"按钮
```typescript
<Button
  type="default"
  onClick={handleCollect}
  disabled={!hasValidDimensions}
>
  采集
</Button>
```

#### 改动3：采集按钮逻辑
```typescript
const hasValidDimensions = useMemo(() => {
  return !!(
    productData.width &&
    productData.height &&
    productData.depth &&
    productData.weight
  );
}, [productData]);

const handleCollect = async () => {
  if (!hasValidDimensions) {
    notification.error({
      message: '尺寸和重量数据缺失，请刷新重试'
    });
    return;
  }

  const response = await apiClient.post('/ozon/collection-records/collect', {
    source_url: window.location.href,
    source_product_id: productData.product_id,
    product_data: productData,
    shop_id: selectedShop
  });

  if (response.ok) {
    notification.success({
      message: '商品已采集，请到系统采集记录中查看',
      duration: 3
    });
    // 不关闭窗口，用户可以继续采集
  }
};
```

#### 改动4：跟卖按钮逻辑调整
```typescript
const handleFollowPdp = async () => {
  const response = await apiClient.post('/ozon/collection-records/follow-pdp', {
    shop_id: selectedShop,
    source_url: window.location.href,
    product_data: productData,
    variants: enabledVariants,
    warehouse_id: selectedWarehouse,
    watermark_id: selectedWatermark
  });

  // 成功后直接关闭窗口（不弹出任何提示）
  if (response.ok) {
    window.close();
  }
};
```

---

### 4.7 异步任务设计

**任务名称**：`ef.ozon.collection_records.poll_listing_status`
**触发方式**：跟卖上架后自动触发（Celery 异步任务）

**Cron 表达式**：无（仅手动触发）

**任务逻辑**：
```python
@celery_app.task(name="ef.ozon.collection_records.poll_listing_status")
async def poll_listing_status_task(record_id: int):
    service = CollectionRecordService()

    # 最多重试 10 次，指数退避
    for attempt in range(10):
        record = await service.get_record(record_id)

        # 调用 OZON API 查询任务状态
        ozon_status = await ozon_api.get_import_task_status(record.listing_task_id)

        if ozon_status.state == 'created':
            # 上架成功，创建正式商品记录
            product = await service.create_product_from_record(record)
            await service.update_record_status(
                record_id,
                'success',
                listing_product_id=product.id
            )
            break
        elif ozon_status.state == 'failed':
            # 上架失败，保存错误信息
            await service.update_record_status(
                record_id,
                'failed',
                error_message=ozon_status.error_message
            )
            break
        else:
            # 继续等待，指数退避
            await asyncio.sleep(2 ** attempt)
```

---

## 五、可观测性设计

### 5.1 日志

**日志级别**：
- INFO - 正常流程（采集成功、上架成功）
- ERROR - 异常流程（API 错误、数据校验失败）

**日志字段**：
```json
{
  "user_id": 123,
  "action": "collect_product",
  "record_id": 456,
  "source_url": "https://www.ozon.ru/product/1234567890",
  "duration_ms": 250,
  "timestamp": "2025-11-15T10:30:00Z"
}
```

**脱敏规则**：
- 不输出完整的 `product_data`（仅输出 `product_id`）
- 不输出用户敏感信息

---

### 5.2 指标

**指标命名**：
- `ef_ozon_collection_records_total` (counter) - 采集记录总数
  - Labels: `collection_type` (`follow_pdp` | `collect_only`)
- `ef_ozon_listing_success_total` (counter) - 上架成功总数
- `ef_ozon_listing_failed_total` (counter) - 上架失败总数
  - Labels: `error_code` (OZON API 错误码)
- `ef_ozon_listing_duration_ms` (histogram) - 上架耗时
  - Buckets: [100, 500, 1000, 3000, 5000, 10000]

---

### 5.3 告警

**告警规则**：
1. **上架失败率过高**：
   - 条件：`ef_ozon_listing_failed_total / ef_ozon_listing_success_total > 0.1`（失败率 > 10%）
   - 通知：Telegram/钉钉

2. **上架耗时过长**：
   - 条件：`ef_ozon_listing_duration_ms` P95 > 10000ms（10秒）
   - 通知：Telegram/钉钉

---

## 六、数据库迁移

### 6.1 迁移脚本

```bash
# 生成迁移脚本
alembic revision -m "add_ozon_product_collection_records_table"

# 应用迁移
alembic upgrade head
```

### 6.2 迁移内容（upgrade）

```python
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects.postgresql import JSONB

def upgrade():
    op.create_table(
        'ozon_product_collection_records',
        sa.Column('id', sa.BigInteger(), primary_key=True),
        sa.Column('user_id', sa.Integer(), sa.ForeignKey('users.id'), nullable=False),
        sa.Column('shop_id', sa.Integer(), sa.ForeignKey('ozon_shops.id'), nullable=True),
        sa.Column('collection_type', sa.String(20), nullable=False),
        sa.Column('source_url', sa.Text(), nullable=False),
        sa.Column('source_product_id', sa.String(100), nullable=True),
        sa.Column('product_data', JSONB(), nullable=False),
        sa.Column('listing_request_payload', JSONB(), nullable=True),
        sa.Column('listing_task_id', sa.String(100), nullable=True),
        sa.Column('listing_status', sa.String(50), nullable=True),
        sa.Column('listing_product_id', sa.BigInteger(), nullable=True),
        sa.Column('listing_error_message', sa.Text(), nullable=True),
        sa.Column('listing_at', sa.DateTime(), nullable=True),
        sa.Column('is_read', sa.Boolean(), default=False),
        sa.Column('is_deleted', sa.Boolean(), default=False),
        sa.Column('last_edited_at', sa.DateTime(), nullable=True),
        sa.Column('last_edited_by', sa.Integer(), sa.ForeignKey('users.id'), nullable=True),
        sa.Column('created_at', sa.DateTime(), nullable=False, server_default=sa.text("(NOW() AT TIME ZONE 'UTC')")),
        sa.Column('updated_at', sa.DateTime(), nullable=False, server_default=sa.text("(NOW() AT TIME ZONE 'UTC')")),
        sa.CheckConstraint("collection_type IN ('follow_pdp', 'collect_only')", name='chk_collection_type')
    )

    # 创建索引
    op.create_index('idx_collection_user', 'ozon_product_collection_records', ['user_id', 'created_at'])
    op.create_index('idx_collection_type_status', 'ozon_product_collection_records', ['collection_type', 'listing_status'])
    op.create_index('idx_collection_shop', 'ozon_product_collection_records', ['shop_id'], postgresql_where=sa.text('shop_id IS NOT NULL'))
```

### 6.3 回滚方案（downgrade）

```python
def downgrade():
    op.drop_index('idx_collection_shop', table_name='ozon_product_collection_records')
    op.drop_index('idx_collection_type_status', table_name='ozon_product_collection_records')
    op.drop_index('idx_collection_user', table_name='ozon_product_collection_records')
    op.drop_table('ozon_product_collection_records')
```

---

## 七、验收标准

### 7.1 功能测试

- [ ] 测试用例1：采集缺失尺寸/重量数据 → 提示错误，不发送请求
- [ ] 测试用例2：采集成功 → 提示"商品已采集，请到系统采集记录中查看"
- [ ] 测试用例3：跟卖上架成功 → 窗口直接关闭，不弹出提示
- [ ] 测试用例4：上架记录页面显示正确状态（pending → processing → success）
- [ ] 测试用例5：上架记录编辑功能 → 修改价格/标题后保存成功
- [ ] 测试用例6：采集记录点击"上架" → 跳转新建商品页，数据自动填充
- [ ] 测试用例7：删除记录 → 软删除，列表不再显示

---

### 7.2 性能测试

- [ ] API 响应时间 < 500ms（P95）
- [ ] 数据库查询次数 ≤ 10 次
- [ ] 并发 100 QPS 无错误

---

### 7.3 代码质量

- [ ] `ruff`/`mypy` 通过（后端）
- [ ] `eslint`/`tsc` 通过（前端）
- [ ] 测试覆盖率 ≥ 80%
- [ ] 所有 TODO 已清理

---

## 八、风险与依赖

### 8.1 技术风险

**风险1**：OZON API 上架异步任务轮询失败
- **缓解措施**：实现指数退避重试（最多 10 次），超时标记为 `failed`

**风险2**：浏览器扩展与后端 API 版本不一致
- **缓解措施**：API 添加版本号校验，扩展启动时检查兼容性

**风险3**：采集记录数据量过大影响查询性能
- **缓解措施**：
  - 添加分页（每页 20 条）
  - 索引优化（`idx_collection_user`）
  - 定期归档（软删除记录 30 天后物理删除）

---

### 8.2 外部依赖

**依赖1**：OZON API（`/v1/product/import`）
- **SLA**：99.5%
- **风险**：OZON API 故障导致上架失败
- **缓解**：记录错误信息，支持重新上架

---

### 8.3 阻塞因素

- 无阻塞因素

---

## 九、开发计划

### 9.1 任务分解

**后端任务**（预计 2 天）：
- [ ] 创建数据库迁移脚本（0.5 天）
- [ ] 创建数据模型和服务层（1 天）
- [ ] 创建 API 路由（0.5 天）

**前端任务**（预计 2 天）：
- [ ] 调整菜单和路由（0.5 天）
- [ ] 创建上架记录和采集记录页面（1 天）
- [ ] 修改商品创建页面（支持恢复采集记录）（0.5 天）

**浏览器扩展任务**（预计 0.5 天）：
- [ ] 修改 PublishModal 组件（0.5 天）

**测试任务**（预计 1 天）：
- [ ] API 测试（0.5 天）
- [ ] 前端功能测试（0.5 天）

---

### 9.2 里程碑

- **M1**：完成后端 API（Day 2）
- **M2**：完成前端页面（Day 4）
- **M3**：测试通过，上线（Day 5）

---

## 十、附录

### 10.1 参考文档
- [CLAUDE.md](../../CLAUDE.md) - 开发规范
- [COMPONENTS.md](../../COMPONENTS.md) - 可复用组件
- [FAQ.md](../../FAQ.md) - 常见问题
- [OZON API 文档](../../docs/OzonAPI/index.html)

### 10.2 术语表
- **跟卖**：复制 OZON 平台已有商品的详情，直接上架到自己店铺（FOLLOW_PDP 模式）
- **采集**：从 OZON 商品详情页抓取数据，保存到系统，待后续编辑上架
- **上架记录**：跟卖上架的商品记录，追踪上架全流程状态
- **采集记录**：普通采集的商品记录，不立即上架

---

**文档维护者**：Claude (EuraFlow 产品经理)
**最后更新**：2025-11-15
