# EuraFlow—OPERATIONS.md（修订版）
> 适用于 EuraFlow（欧亚流）平台的运维与可靠性工程（SRE）规范与操作跑法。与《CODESTYLE.md（修订版）》《RELEASE.md（修订版）》《COMPLIANCE.md》《风险雷达与上线清单》《OZON PRD/SRS》配套。

---

## 1. 目标与范围
- 目标：**可靠（SLO）｜可观测（Logs/Metrics/Traces）｜可恢复（RPO/RTO）｜可回滚（Feature Flag + 版本回退）｜可扩容**。
- 范围：`ef-core`、`ef-plugin-*`、前端 `@ef/*`、数据库/缓存/消息队列/对象存储/反向代理。

---

## 2. 值班（On‑call）与升级（Escalation）
- 轮值：7×24；每班 1 一线 + 1 二线；渠道：IM 值班群 + 事故视频房间。
- 升级：P1（立即）→ 二线 10 分钟内接手；P2（30 分钟内）；P3（工作时间内）。
- 值班自检：
  - [ ] 通知通路（IM/短信/电话）试呼
  - [ ] 核心仪表盘：无红灯；SLO 未越线
  - [ ] 队列积压 < 80% 阈值；DB 连接 < 70% 上限

---

## 3. 可观测性（Logging / Metrics / Tracing）
### 3.1 日志（JSON）
- 必含：`ts, level, trace_id, plugin, action, shop_id, latency_ms, result, err`。
- 脱敏：账号、姓名、电话、地址、token 按白名单输出；禁止明文密钥。

### 3.2 指标（Prometheus 命名示例）
- 订单拉取耗时：`ef_ozon_orders_pull_latency_ms`（histogram）
- 订单拉取失败：`ef_ozon_orders_pull_fail_total`
- 发货回传耗时/失败：`ef_ozon_shipments_push_latency_ms` / `..._fail_total`
- 库存/价格回传失败：`ef_ozon_inventory_push_fail_total`、`ef_ozon_price_push_fail_total`
- 队列积压：`ef_tasks_backlog{plugin="ef.channels.ozon"}`
- FX 刷新延迟（如实现）：`ef_fx_refresh_latency_ms`

### 3.3 Trace（OpenTelemetry）
- HTTP/DB/队列链路接入；`trace_id` 回写日志；关键跨度命名规范：`ozon.pull.orders`、`ozon.push.shipments` 等。

### 3.4 SLI/SLO（首批）
- 新单 TTD（平台→入库）P95 ≤ 5m；发货回传成功率 ≥ 99.5%；回传延迟 P95 ≤ 3m。

---

## 4. 告警（Alerting）与静默
- 路由：IM → 电话（夜间 P1）。
- 基线阈值（示例，可按店铺调整）：
  - `ef_ozon_orders_pull_fail_total` 5 分钟内 > **50** → **P1**
  - `ef_tasks_backlog{plugin="ef.channels.ozon"}` > **5k** 且增长 → **P2**
  - DB p95 查询 > **500ms** 持续 10 分钟 → **P2**
  - 错误预算 7 天耗尽率 > **100%** → 进入变更冻结
- 静默：发布窗口、演练窗口按标签静默；事故期间对噪音告警临时抑制并复盘后收敛。

---

## 5. 配置、密钥与权限
- 配置分层：环境变量（`EF__*`）→ 配置中心/KV → 运行时开关（Feature Flag）。
- 密钥托管与轮换：KMS/密钥管家优先；至少季度轮换；审计所有读取与变更。
- RBAC：以动作粒度授权（如 `orders:read/sync`、`inventory:push`）；敏感操作二次确认与审计。

---

## 6. 容量与性能基线
- 规划：以旺季 **3×** 负载预估；关键路径压测（拉单/回传/入库）。
- 数据库：连接池大小 ≈ `2 × vCPU`（初始值）；慢查询阈值 **300ms**；热点索引定期评审。
- 队列：任务粒度建议 **100–200** 条/批；并发与限速按**插件/店铺**维度配置。
- 防抖：对上游设置**退避/熔断**；对内部设置**舱壁隔离**（不同插件/店铺线程池隔离）。

---

## 7. 备份与恢复（PITR）
- 备份：
  - 数据库：全量（每日）+ WAL（每 5 分钟）
  - 对象存储：版本化 + 生命周期规则
- 目标：RPO ≤ **15 分钟**；RTO ≤ **1 小时**。
- 恢复演练：**每月**一次（含校验与业务抽样核对）。
- 版本与产物：保留最近 **3** 个发布物与依赖包，遇到网络限制亦可完成恢复。
- 恢复步骤模板：
  1) 选定恢复时间点（UTC）
  2) 建立隔离恢复库 → 校验校验和/行数 → 业务级抽样核对
  3) 切换读流量/灰度写 → 完整回切

---

## 8. 事故响应（Incident）
### 8.1 严重级别（Sev）
- **P1**：数据丢失/大面积中断/财务对账失败
- **P2**：核心插件退化/同步延迟严重（> SLO 2×）
- **P3**：局部功能异常/单店铺问题

### 8.2 War‑room 流程
1) 宣告 + 建立纪要（记录 TL/SME/抄送）
2) 冻结变更，启用应急开关/回退
3) 分工：定位（日志/指标/Trace）→ 缓解 → 根因 → 修复
4) T+1 复盘：时间线、根因 5 Whys、行动项（负责人/截止日）

### 8.3 对外沟通（如适用）
- 事故外部通告与客户沟通模板；时间线和影响面透明且可审计。

---

## 9. 变更管理（Change）与窗口
- 类型：标准/紧急/特批；紧急需二线批准。
- 窗口：工作日 **18:00–22:00**，周末 **10:00–18:00**；灰度先行，金丝雀 ≥ **10%**。
- 发布步骤与回滚参见《RELEASE.md（修订版）》；所有变更需在 PR 附上**回滚方案**与**监控计划**。

---

## 10. Runbook 模板（样例）
```
# 名称：ef.ozon.orders 拉单延迟高
## 症状
- ef_ozon_orders_pull_latency_ms P95 > 2min 持续 10 分钟
## 可能原因
- 上游 429 / 5xx；内部批量过大；队列堵塞
## 诊断步骤
- 外部错误率、限流命中；DB 锁等待；队列 backlog；近版发布记录
## 缓解
- 下调并发/批量；启用退避；临时静默非核心同步
## 根因修复
- 增加指数退避；优化索引与查询；按店铺限速
```

```
# 名称：发货回传失败骤增
## 症状
- ef_ozon_shipments_push_fail_total 5 分钟 > 50
## 诊断
- 检查 Problem Details code；平台回执；网络抖动/证书/密钥
## 缓解
- 延长重试间隔；人工回传关键订单；必要时停用新开关
## 根因修复
- 修复映射/参数；加速率保护；与平台沟通配额
```

---

## 11. 运营与对账
- T+1 对账：平台结算单导入；订单/物流/财务三账核对；差异进入**悬挂账**并有工单闭环。
- 监控报表：销售/订单/退款率/在途/库存周转/物流时效；支持按店铺/渠道/地区/SKU 维度钻取。

---

## 12. 成本与效率
- 指标：云账单、对象存储流量、日志/指标保留期、单任务成本。
- 策略：冷热数据分层；限制日志字段与基数；按店铺/插件限流；计算/存储配额定期审视。

---

## 13. 周/月例行
- 每周：
  - [ ] 错误预算复盘与变更节奏评审
  - [ ] 慢查询 Top10 优化计划
  - [ ] 告警规则与噪音压降审查
- 每月：
  - [ ] 灾备/PITR 演练一次
  - [ ] 回滚演练一次（含数据库向后兼容验证）
  - [ ] 依赖与 SBOM 更新；高危漏洞清零

---

## 14. 安全与合规（摘录）
- 参照《COMPLIANCE.md》：数据分级、最小化、脱敏、留存周期、主体权利响应。
- 审计：登录、权限变更、敏感数据读取/导出、配置变更、插件启停/升级均有审计记录。

---

## 15. 环境与部署基线（信息化标准）
- 服务管理：采用所在平台提供的**进程/服务管理器**运行 API、Worker、Scheduler（例如 systemd 或等价能力）。
- 反向代理：由 Web 服务器提供（例如 Nginx/Caddy 或等价能力）。
- 发布物：代码包、依赖离线包、前端静态产物；通过自动化工具批量分发与切换；支持版本回退。
- 健康检查：`/healthz`、关键接口抽测、自检仪表盘。

