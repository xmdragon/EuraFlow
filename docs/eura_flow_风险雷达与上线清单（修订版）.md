# EuraFlow—风险雷达与上线清单（修订版）
> 目标：在需求→设计→开发→联调→发布全周期识别与规避高风险；上线前统一走 **Go/No‑Go** 清单。配套文档：`CODESTYLE.md（修订版）`、`RELEASE.md（修订版）`、`OPERATIONS.md（修订版）`、`COMPLIANCE.md`、`OZON PRD/SRS`。

---

## A. 风险雷达（Top Risks by Area）
> 维度：**概率（P）/影响（I）/暴露（E）**，评分 1–5；优先级 = P×I×E。列出**信号**、**护栏**（工程闸门）、**缓解**、**负责人**。

### A.1 外部平台与集成（Ozon 首发重点）
| 风险 | 迹象/信号 | 护栏（Gate） | 缓解与应对 | Owner |
|---|---|---|---|---|
| 平台限流/429 堵塞 | 错误码 429 激增、延迟上升、backlog 增长 | 连接器限速参数校验；UAT 压测 3× 峰值 | 指数退避、并发下调、分店铺隔离、熔断与恢复探针 | Tech Lead/连接器 RD |
| 分页/增量丢单 | 订单数对不上、posting_number 间断 | 合同测试覆盖分页；对账抽样≥1000单 | 增量窗口+1 重叠、幂等键去重、断点续拉 | RD/QA |
| 幂等冲突/重复写 | 重复订单/运单 | 唯一键预检查；冲突单元测试 | 业务幂等键：`platform+shop_id+external_id`；写前查重 | RD |
| 发货回传失败 | `...push_fail_total` 升高 | 回传回执存档；错误分类策略通过 | 5xx/429 重试≤5；4xx（非429）不重试；人工补单脚本 | RD/运营 |
| 地址/编码异常 | 俄文长地址、邮编不合法 | 地址校验器/标准化单元测试 | E.164 电话；邮编 `^\d{6}$`；UTF‑8 存储；截断保原值 | RD/QA |
| 汇率波动致亏价 | 价格/毛利异常报警 | 价格守护阈值校验 | CNY→RUB 快照；毛利下限阻断+审批 | 产品/财务 |

### A.2 数据与存储
| 风险 | 迹象/信号 | 护栏 | 缓解 |
|---|---|---|---|
| 模型变更不兼容 | 迁移失败/回滚困难 | Expand/Contract 设计评审 | 回填/双写/开关切换；提供 downgrade；灰度验证 |
| 热点/慢查询 | p95>300ms，CPU 飙升 | 计划内压测；索引评审 | 改写查询、加索引、读写分离（如适用） |
| 数据漂移/对账差异 | 三账不齐 | T+1 对账流程 | 影子写+悬挂账+人工复核 |

### A.3 可靠性与容量
| 风险 | 迹象/信号 | 护栏 | 缓解 |
|---|---|---|---|
| 队列积压/雪崩 | backlog 高且上升 | 并发/批量基线检查 | 舱壁隔离、限流降级、暂停非核心任务 |
| 单点依赖不可用 | 外部 API 超时增多 | 健康探针/熔断 | 本地队列缓存、改人工流程、通知业务 |

### A.4 安全与合规
| 风险 | 迹象/信号 | 护栏 | 缓解 |
|---|---|---|---|
| 机密泄露/弱管控 | 日志出现 token/PII | 安全审计门；脱敏检查 | `EF__*` 注入；最小化收集；日志脱敏白名单 |
| 依赖漏洞/漂移 | 审计红灯 | SBOM+依赖审计 | `pip-compile+hashes`；按版本归档 wheelhouse；升级评估 |
| 业务合规（EAC/禁限/品牌池/HS） | 被平台警告 | 合规规则引擎闸门 | 黑名单类目/品牌池校验，证照台账与到期提醒 |

---

## B. Go/No‑Go 上线清单（可打印）
> 勾选项全部为 **必需**。如未满足，需明确豁免与会签。

### B.1 范围与验收
- [ ] 上线范围冻结（PRD §3），Out‑of‑Scope 项另行排期
- [ ] UAT 用例 **100% 通过**（附表 B CSV），含正/反/边界/性能
- [ ] 数据映射表最新（附表 A CSV），抽样对账 **≥1000 单** 偏差 ≤ 0.1‰

### B.2 观测与告警
- [ ] 日志 JSON 脱敏启用，关键字段齐全（`trace_id/plugin/action/...`）
- [ ] 指标面板到位：`ef_ozon_orders_pull_latency_ms`、`...push_fail_total`、`ef_tasks_backlog{plugin}` 等
- [ ] 告警阈值按店铺配置；路由（IM/电话）测试通过

### B.3 配置与权限
- [ ] 机密与配置经审阅；以 `EF__*` 注入；无硬编码
- [ ] RBAC 权限点到位（`orders:read/sync`、`shipments:push`、`inventory:push`、`price:update`、`returns:read`）
- [ ] 审计事件开启：登录、权限变更、配置变更、手动同步/回传

### B.4 发布与回滚
- [ ] 发布物三件套已分发：代码包 / 依赖包 / 前端静态；SBOM 归档
- [ ] 迁移脚本 Expand/Contract 评审通过；**回滚脚本可演练**
- [ ] 金丝雀名单与放量计划（10%→30%→100%）已评审；回退路径清晰

### B.5 运营准备
- [ ] Runbook 两份：**“拉单延迟高”**、**“回传失败骤增”**；值班排班完成
- [ ] 客服/财务沟通口径与 FAQ 更新（COD、退货、对账差异）

---

## C. 发布流程检查（现场）
- **T‑1 h**：冻结非相关变更；回顾回滚方案与开关位
- **T‑0**：发布 → 健康检查 `/healthz` 200 → 抽测接口（读/写各 1）
- **T+30/60 min**：金丝雀扩容；观察：
  - 订单 TTD P95、回传延迟 P95、失败总数、队列 backlog 曲线
  - 5×N 订单抽样（含 COD、部分发货、长地址）
- **触发回退条件**（任一成立）：
  - P1 事故；核心指标越线且 30 分钟无改善；对账重大差异

---

## D. 发布后（T+1/T+7）
- **T+1**：
  - 对账报告：偏差≤0.1‰；差异入**悬挂账**并有工单流转
  - 指标曲线复盘；错误 TopN 整改单
- **T+7**：
  - 召回/回溯问题清单；更新测试用例与监控阈值
  - 再评估并发/批量/限速基线（按真实负载）

---

## E. 准备度评分卡（Readiness Scorecard）
> 评分：0=未开始 / 1=进行中 / 2=完成 / 3=已演练

| 类别 | 条目 | 得分 | 备注 |
|---|---|---:|---|
| 需求/范围 | PRD 冻结，依赖澄清 |  |  |
| 测试/质量 | UAT/契约/回归/性能通过 |  |  |
| 数据/迁移 | 映射/迁移/回滚演练 |  |  |
| 观测/告警 | 指标/日志/Trace/阈值 |  |  |
| 安全/合规 | 机密/脱敏/SBOM/审计 |  |  |
| 运维/值班 | Runbook/排班/演练 |  |  |
| 发布/回退 | 放量/回滚/补偿 |  |  |

---

## F. 变更票模板（Change Ticket）
```markdown
# 变更标题：
## 范围
- 模块：
- 影响面：
## 风险与缓解
- 风险：
- 缓解：
## 监控与告警
- 指标与阈值：
## 放量与回滚
- 放量计划：10%→30%→100%
- 回滚路径：版本/脚本/数据处理
## 验收标准
- UAT 用例编号：
- 抽测脚本：
```

---

## G. “拉闸”条件（Stop‑the‑line）
- 任意核心指标越过 P1 阈值并 **10 分钟无改善**
- 数据损坏风险（不满足幂等/迁移不可逆）
- 合规/隐私事件：明文机密、PII 外泄

---

## H. 附录：度量与命名规范速查
- 指标前缀：`ef_*`；错误模型：Problem Details；时间：入库 UTC；金额：Decimal（18,4）
- 常用指标键：
  - `ef_ozon_orders_pull_latency_ms{shop_id=,status=}`
  - `ef_ozon_shipments_push_fail_total{carrier=}`
  - `ef_tasks_backlog{plugin="ef.channels.ozon"}`

> 本清单保持与各修订版文档一致；如流程或阈值调整，请同步在此更新并通知值班组。

