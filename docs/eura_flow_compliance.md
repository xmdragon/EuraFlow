# EuraFlow—COMPLIANCE.md（修订版）
> 目的：为 EuraFlow（欧亚流）在 **跨境电商（中国→俄罗斯）** 场景下提供数据保护、隐私合规、供应链安全与审计的统一标准。适用于 ef‑core、ef‑plugin‑*、@ef/*、运维与业务团队。
>
> 声明：本文为工程与流程规范，**非法律意见**；涉及法规解释与跨境传输要求，请与法务/外部顾问确认后执行。

---

## 1. 适用对象与范围
- 对象：订单/支付（含 COD 标识）/物流/退货退款/价格库存/账号权限/日志与指标等。
- 生命周期：采集 → 传输 → 存储 → 使用 → 共享/第三方 → 留存/删除 → 审计/取证。

---

## 2. 术语
- **PII**：可识别个人信息（如姓名、电话、地址、邮箱）。
- **敏感数据**：PII 中的重要子集（如身份证件号、精确地址、支付标识）。
- **数据主体请求（DSR）**：访问、更正、删除、导出等请求。
- **处理基础（Lawful Basis）**：履行合同、法定义务、合法权益、同意等。

---

## 3. 数据分级（四级）
| 级别 | 名称 | 示例 | 控制要求 |
|---|---|---|---|
| L0 | 公开 | 帮助文档、营销页 | 无涉密，但防篡改 |
| L1 | 内部 | SKU 维度运营数据、聚合报表 | 访问控制、最小权限 |
| L2 | 敏感 | 订单明细（含姓名/电话/地址）、退款记录、运单号 | 传输/存储加密、日志脱敏、RBAC、审计 |
| L3 | 严格 | 支付凭证、证照影印、身份识别信息（如存在） | 强加密、访问审批、按需隔离、专门审计 |

> **默认**：订单/物流/退退涉及买家信息，**按 L2** 管控；若含证照/税号等则评估为 **L3**。

---

## 4. 数据目录（按实体）
> 每次新增字段需更新本表；“必要性/目的/留存期”影响审批与审计。

| 实体 | 字段示例 | 级别 | 目的 | 留存期（建议） |
|---|---|---:|---|---|
| orders | buyer_name, buyer_phone_raw/e164, email, address_* | L2 | 履行订单/物流 | 3 年（与财务对账周期对齐） |
| order_items | sku, qty, price_rub | L1 | 履行订单 | 3 年 |
| shipments | carrier_code, tracking_no, packages | L1/L2（含地址时 L2） | 履行物流 | 2 年 |
| returns/refunds | reason, amount_rub | L2 | 售后、对账 | 3 年 |
| listings | price_rub, price_old_rub | L1 | 定价/合规 | 2 年 |
| logs/metrics | trace_id, plugin, err（脱敏） | L1 | 观测/取证 | 90 天（热）+ 365 天（冷） |

> “留存期”以**法定最低+业务需要**择高；各地区法规差异以本地合规清单为准。

---

## 5. 合法性与同意
- **履行合同/服务**：处理订单、物流、售后所必需字段（默认基础）。
- **法定义务**：财税留存、对账、监管报送（按地适用）。
- **合法权益**：防欺诈、维权；须实施最小化与保护措施。
- **同意**：用于营销/画像/非必需用途时需取得明示同意并可撤回。

---

## 6. 最小化与目的限制
- 只收集**完成交易与履约**所需最少字段；禁止“以防万一”采集。
- 禁止将 PII 用于与原目的不兼容的二次处理（除非再次征得同意或符合法规例外）。

---

## 7. 加密与密钥管理
- **传输加密**：TLS 1.2+；HSTS；禁用弱套件。
- **存储加密**：磁盘级加密 + 关键列（如邮箱、证照号）可选字段级加密。
- **密钥**：由密钥管家/KMS 托管；以 `EF__*` 环境变量注入应用；季度轮换；最小暴露面；严禁写入代码/日志。

---

## 8. 访问控制与审计
- **RBAC**：按动作授权（例：`orders:read/sync`、`shipments:push`）；默认拒绝。
- **敏感操作**：二次确认（Just‑In‑Time）；临时权限自动回收。
- **审计日志**（不可改写/WORM 归档）：登录、权限变更、配置变更、数据导出/删除、手动同步/回传。

---

## 9. 日志与脱敏（强制）
- **禁止**输出明文：token、密码、证照号、邮箱、电话、精确地址。
- 推荐脱敏规则：
  - 电话：`+7 916****567` / `+86 138****5678`
  - 邮箱：`f***@example.com`
  - 地址：仅保留城市/行政区 + 哈希片段（`sha256(street)[:6]`）
- 日志字段统一：`ts, level, trace_id, plugin, action, shop_id, latency_ms, result, err`；时间使用 UTC。

---

## 10. 数据留存与删除
- **默认**：业务数据 L1/L2 留存 2–3 年；日志/指标 90 天热存 + 365 天归档；按需延展以满足财税/合规。
- **删除/匿名化**：过期即删除或不可逆匿名化；有对账/法定保留义务的，采用**脱敏冻结**。
- **批量清理**：按月作业；输出清理报告与删除计数，纳入审计。

---

## 11. 第三方与跨境传输
- **第三方清单**：Ozon 平台、承运商（CDEK/Boxberry/Почта等）、支付/结算、对象存储/消息与监控服务等。
- **最小共享**：仅共享任务所需字段；默认去标识化（如可能）。
- **跨境传输**：传输与存储均加密；区域存储优先；必要时进行 DPIA/传输影响评估并与法务确认合同条款（SCC/附加条款）。

---

## 12. 供应链安全（依赖与构建）
- **SBOM**：前后端均生成并归档；纳入发布物。
- **依赖锁定**：`pip-compile --generate-hashes` / npm integrity；CI 产出可复现依赖包。
- **审计**：`pip-audit`/`npm audit`；高危在发布前修复或豁免备案。
- **篡改防护**：发布物签名/校验；来源镜像/仓库白名单。

---

## 13. 数据主体请求（DSR）流程
- **受理入口**：客服/运营或客服系统工单。
- **SLA**：受理 3 个工作日内响应；复杂请求 30 日内完成（或提供进度）。
- **流程**：
  1) 身份核验（避免误删/越权导出）
  2) 检索相关订单/记录 → 导出/更正/删除
  3) 受限项（财税留存/纠纷保全）采用脱敏冻结
  4) 向请求人反馈完成结果（含范围与例外）
- **记录**：在审计系统存证（工单号、时间线、处理人、结果）。

---

## 14. 事件响应（泄露/违规/重大故障）
- **分级**：P1（大规模泄露/对账重大风险）/P2（局部影响）/P3（潜在风险）。
- **流程**：发现 → 升级 → 证据保全 → 缓解（隔离、撤权、密钥轮换、撤下发布）→ 根因 → 通报 → 复盘。
- **时限**：内部即时通知；外部通报依照当地法规与合同约定（与法务确认）。

---

## 15. 设计评审与 DPIA 触发
- 触发条件：
  - 新增 L3 级字段；
  - 新的监控/画像/自动化决策；
  - 跨境存储或处理地点变更；
  - 新第三方引入或共享范围扩大。
- 输出：风险清单、缓解措施、残余风险、批准与复核计划。

---

## 16. 表单与清单（可打印）
### 16.1 字段登记表（样例）
```
字段：buyer_phone_e164
级别：L2
来源：Ozon API
目的：履约通知与售后沟通
合法性：合同必要
留存：3 年
责任人：运营负责人
```

### 16.2 DSR 工单（样例）
```
请求类型：删除/导出/更正
主体标识：订单号/邮箱/电话（至少二要素）
范围：2024-01-01 ~ 2025-12-31
例外：财税留存/纠纷保全
结果：已完成/部分完成/拒绝（原因）
```

### 16.3 变更评审勾选
- [ ] 新增/变更字段是否更新《数据目录》
- [ ] 是否触发 DPIA
- [ ] SBOM/依赖审计已通过
- [ ] 日志脱敏单测覆盖

---

## 17. 与工程规范的衔接
- **CODESTYLE**：日志/错误模型（Problem Details）、UTC 时间、Decimal 金额等保持一致。
- **RELEASE**：发布物三件套、SBOM 归档、回滚与影子写/对账建议。
- **OPERATIONS**：告警阈值、Runbook、备份与恢复（PITR）。
- **PRD/SRS**：权限点、字段映射、幂等与状态机约束。

---

## 18. 附录：脱敏与正则速查
- 邮编：`^\d{6}$`（RU）
- 电话（E.164）：`^\+[1-9]\d{6,14}$`
- 价格/金额：Decimal(18,4)；禁止浮点参与结算
- JSON 日志字段：`{"ts":"..","level":"..","trace_id":"..","plugin":"..","action":"..","shop_id":1001,"latency_ms":123,"result":"ok"}`

---

> 本规范每季度评审一次；若法规或业务场景发生重大变化，需提前滚动更新。

