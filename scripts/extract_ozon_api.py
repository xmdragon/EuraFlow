#!/usr/bin/env python3
"""
OZON APIÊñáÊ°£ÊèêÂèñÂ∑•ÂÖ∑ÔºàHTMLÁâàÊú¨Ôºâ
‰ªéÂéüÂßãHTMLÊñáÊ°£‰∏≠ÊèêÂèñÊØè‰∏™APIÊìç‰ΩúÁöÑÂÆåÊï¥HTMLÁâáÊÆµ
"""

import os
import re
from pathlib import Path
from bs4 import BeautifulSoup
from typing import Dict, List, Optional

# ÈÖçÁΩÆ
HTML_FILE = "docs/OzonSellerAPI.html"
OUTPUT_DIR = "docs/OzonAPI"


def sanitize_filename(name: str) -> str:
    """Ê∏ÖÁêÜÊñá‰ª∂Âêç‰∏≠ÁöÑÈùûÊ≥ïÂ≠óÁ¨¶"""
    name = name.replace('/', '_')
    name = name.replace('\\', '_')
    name = name.replace('?', '')
    name = name.replace('*', '')
    name = name.replace(':', '-')
    name = name.replace('<', '')
    name = name.replace('>', '')
    name = name.replace('|', '-')
    name = name.replace('"', '')
    if len(name) > 100:
        name = name[:100]
    return name.strip()


def extract_styles(soup: BeautifulSoup) -> str:
    """ÊèêÂèñÈ°µÈù¢ÁöÑCSSÊ†∑Âºè"""
    styles = []

    # ÊèêÂèñÊâÄÊúâstyleÊ†áÁ≠æ
    for style_tag in soup.find_all('style'):
        styles.append(style_tag.string or '')

    # ÊèêÂèñlinkÊ†áÁ≠æÂºïÁî®ÁöÑCSSÔºàÂÜÖËÅîÊòæÁ§∫Ôºâ
    # Ê≥®ÊÑèÔºöÂÆûÈôÖCSSÊñá‰ª∂ÂÜÖÂÆπÊó†Ê≥ïËé∑ÂèñÔºåËøôÈáåÂè™ÊòØÊ†áËÆ∞

    return '\n'.join(styles)


def create_html_template(title: str, content: str, base_styles: str) -> str:
    """ÂàõÂª∫ÂÆåÊï¥ÁöÑHTMLÊñáÊ°£"""
    return f"""<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title} - OZON API</title>
    <style>
        body {{
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }}
        .api-container {{
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }}
        table {{
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }}
        th, td {{
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }}
        th {{
            background-color: #f8f9fa;
            font-weight: 600;
        }}
        code {{
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "Courier New", monospace;
        }}
        pre {{
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }}
        h1, h2, h3, h4, h5, h6 {{
            color: #333;
            margin-top: 20px;
        }}
        .http-verb {{
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 8px;
        }}
        .http-verb.post {{ background-color: #49cc90; color: white; }}
        .http-verb.get {{ background-color: #61affe; color: white; }}
        .http-verb.put {{ background-color: #fca130; color: white; }}
        .http-verb.delete {{ background-color: #f93e3e; color: white; }}
        .back-link {{
            display: inline-block;
            margin-bottom: 20px;
            color: #007bff;
            text-decoration: none;
        }}
        .back-link:hover {{
            text-decoration: underline;
        }}
    </style>
</head>
<body>
    <div class="api-container">
        <a href="index.html" class="back-link">‚Üê ËøîÂõûÁ¥¢Âºï</a>
        {content}
    </div>
</body>
</html>
"""


def extract_api_section(soup: BeautifulSoup, operation_id: str) -> Optional[str]:
    """ÊèêÂèñÂçï‰∏™APIÁöÑHTMLÂÜÖÂÆπ"""
    # Êü•ÊâæAPIËØ¶ÊÉÖdiv
    detail_div = soup.find('div', {'id': operation_id})
    if not detail_div:
        return None

    # ËøîÂõûËØ•divÁöÑÂÆåÊï¥HTML
    return str(detail_div)


def extract_api_metadata(nav_item) -> Dict:
    """‰ªéÂØºËà™È°π‰∏≠ÊèêÂèñAPIÂÖÉÊï∞ÊçÆ"""
    operation_id = nav_item.get('data-item-id')

    # ÊèêÂèñAPIÂêçÁß∞
    label = nav_item.find('label', {'type': 'operation'})
    if not label:
        return None

    # ÊèêÂèñ‰∏≠ÊñáÂêçÁß∞
    name_div = label.find('div', class_=re.compile('sc-fXEqXD'))
    api_name = name_div.get_text(strip=True) if name_div else operation_id

    # ÊèêÂèñHTTPÊñπÊ≥ï
    method_span = label.find('span', class_=re.compile('operation-type'))
    method = method_span.get_text(strip=True).upper() if method_span else 'POST'

    # ÊèêÂèñË∑ØÂæÑ
    path_div = label.find('div', class_=re.compile('sc-FNZbm'))
    path = path_div.get_text(strip=True) if path_div else ''

    return {
        'operation_id': operation_id,
        'name': api_name,
        'method': method,
        'path': path
    }


def extract_all_apis():
    """ÊèêÂèñÊâÄÊúâAPIÊñáÊ°£"""
    print(f"üìñ ËØªÂèñHTMLÊñá‰ª∂: {HTML_FILE}")

    # ËØªÂèñHTMLÊñá‰ª∂
    with open(HTML_FILE, 'r', encoding='utf-8') as f:
        html_content = f.read()

    print(f"‚úÖ HTMLÊñá‰ª∂Â§ßÂ∞è: {len(html_content) / 1024 / 1024:.2f} MB")

    # Ëß£ÊûêHTML
    print("üîç Ëß£ÊûêHTMLÊñáÊ°£...")
    soup = BeautifulSoup(html_content, 'lxml')

    # ÊèêÂèñÂü∫Á°ÄÊ†∑Âºè
    print("üé® ÊèêÂèñÊ†∑Âºè...")
    base_styles = extract_styles(soup)

    # Êü•ÊâæÊâÄÊúâoperationÁ±ªÂûãÁöÑAPI - Áõ¥Êé•ÈÄöËøá div id Êü•Êâæ
    print("üîé Êü•ÊâæÊâÄÊúâAPIÊìç‰Ωú...")
    operation_divs = soup.find_all('div', id=re.compile(r'^operation/'))

    print(f"‚úÖ ÊâæÂà∞ {len(operation_divs)} ‰∏™APIÊìç‰Ωú\n")

    # ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
    output_path = Path(OUTPUT_DIR)
    output_path.mkdir(parents=True, exist_ok=True)

    # ÊèêÂèñÊØè‰∏™API
    api_list = []
    success_count = 0
    filename_counter = {}

    for i, div in enumerate(operation_divs, 1):
        operation_id = div.get('id')

        # ‰ªé div ‰∏≠ÊèêÂèñÊ†áÈ¢òÂíåË∑ØÂæÑ
        h2_tag = div.find('h2')
        api_name = h2_tag.get_text(strip=True) if h2_tag else operation_id

        # ÊèêÂèñ HTTP ÊñπÊ≥ï
        http_verb = div.find('span', class_=re.compile('http-verb'))
        method = http_verb.get_text(strip=True).upper() if http_verb else 'POST'

        # ÊèêÂèñË∑ØÂæÑ
        path_div = div.find('div', class_=re.compile('sc-gIBoTZ'))
        path = path_div.get_text(strip=True) if path_div else ''

        print(f"[{i}/{len(operation_divs)}] {api_name}")
        print(f"    {method} {path}")

        # ‰ΩøÁî® div Êú¨Ë∫´‰Ωú‰∏∫ HTML ÂÜÖÂÆπ
        html_content = str(div)

        if html_content:
            # ÁîüÊàêÊñá‰ª∂Âêç
            base_filename = sanitize_filename(api_name)

            # Ê£ÄÊü•Êñá‰ª∂ÂêçÊòØÂê¶Â∑≤Â≠òÂú®
            if base_filename in filename_counter:
                count = filename_counter[base_filename]
                filename_counter[base_filename] += 1
                filename = f"{base_filename}_{count}.html"
                print(f"    ‚ö†Ô∏è  Êñá‰ª∂ÂêçÈáçÂ§çÔºåÊ∑ªÂä†Â∫èÂè∑: {count}")
            else:
                filename = base_filename + '.html'
                filename_counter[base_filename] = 1

            # ÂàõÂª∫ÂÆåÊï¥HTMLÊñáÊ°£
            full_html = create_html_template(api_name, html_content, base_styles)

            filepath = output_path / filename
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(full_html)

            print(f"    ‚úÖ Â∑≤‰øùÂ≠ò: {filename}\n")

            api_list.append({
                'name': api_name,
                'method': method,
                'path': path,
                'filename': filename,
                'operation_id': operation_id
            })

            success_count += 1
        else:
            print(f"    ‚ùå ÊèêÂèñÂ§±Ë¥•\n")

    print(f"\n{'='*60}")
    print(f"‚úÖ ÊèêÂèñÂÆåÊàêÔºÅ")
    print(f"   ÊàêÂäü: {success_count}/{len(operation_divs)}")
    print(f"   ËæìÂá∫ÁõÆÂΩï: {OUTPUT_DIR}")
    print(f"{'='*60}\n")

    return api_list


def generate_index(api_list: List[Dict]):
    """ÁîüÊàêÁ¥¢ÂºïHTMLÈ°µÈù¢"""
    print("üìù ÁîüÊàêÁ¥¢ÂºïÈ°µÈù¢...")

    # ÊåâÂäüËÉΩÂàÜÁªÑ
    grouped = {}
    for api in api_list:
        # Ê†πÊçÆË∑ØÂæÑÂâçÁºÄÂàÜÁªÑ
        path_parts = api['path'].split('/')
        if len(path_parts) >= 3:
            group = path_parts[2]  # ‰æãÂ¶Ç product, order, finance
        else:
            group = "ÂÖ∂‰ªñ"

        if group not in grouped:
            grouped[group] = []
        grouped[group].append(api)

    # ÊûÑÂª∫HTML
    html = """<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OZON Seller API ÊñáÊ°£Á¥¢Âºï</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        .search-box {
            margin: 20px 0;
            padding: 10px;
            width: 100%;
            max-width: 500px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .api-list {
            list-style: none;
            padding: 0;
        }
        .api-item {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .api-item:hover {
            background: #e9ecef;
        }
        .api-item a {
            text-decoration: none;
            color: #333;
            display: block;
        }
        .api-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        .api-path {
            font-family: "Courier New", monospace;
            font-size: 14px;
            color: #666;
        }
        .http-method {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }
        .method-post { background-color: #49cc90; color: white; }
        .method-get { background-color: #61affe; color: white; }
        .method-put { background-color: #fca130; color: white; }
        .method-delete { background-color: #f93e3e; color: white; }
        .stats {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OZON Seller API ÊñáÊ°£Á¥¢Âºï</h1>
        <div class="stats">
            <strong>üìä ÁªüËÆ°‰ø°ÊÅØÔºö</strong> ÂÖ± """ + str(len(api_list)) + """ ‰∏™APIÊé•Âè£
        </div>

        <input type="text" class="search-box" id="searchBox" placeholder="ÊêúÁ¥¢APIÂêçÁß∞ÊàñË∑ØÂæÑ..." onkeyup="searchAPI()">

        <div id="apiContent">
"""

    # ËæìÂá∫ÂàÜÁªÑ
    for group in sorted(grouped.keys()):
        html += f'        <h2>{group}</h2>\n'
        html += '        <ul class="api-list">\n'

        for api in sorted(grouped[group], key=lambda x: x['name']):
            method_class = f"method-{api['method'].lower()}"
            html += f'''            <li class="api-item">
                <a href="{api['filename']}">
                    <div class="api-name">
                        <span class="http-method {method_class}">{api['method']}</span>
                        {api['name']}
                    </div>
                    <div class="api-path">{api['path']}</div>
                </a>
            </li>
'''

        html += '        </ul>\n'

    html += """        </div>
    </div>

    <script>
        function searchAPI() {
            const input = document.getElementById('searchBox');
            const filter = input.value.toLowerCase();
            const items = document.getElementsByClassName('api-item');

            for (let i = 0; i < items.length; i++) {
                const text = items[i].textContent || items[i].innerText;
                if (text.toLowerCase().indexOf(filter) > -1) {
                    items[i].style.display = '';
                } else {
                    items[i].style.display = 'none';
                }
            }
        }
    </script>
</body>
</html>
"""

    # ‰øùÂ≠òÁ¥¢Âºï
    index_path = Path(OUTPUT_DIR) / 'index.html'
    with open(index_path, 'w', encoding='utf-8') as f:
        f.write(html)

    print(f"‚úÖ Á¥¢ÂºïÊñá‰ª∂Â∑≤ÁîüÊàê: {index_path}\n")


if __name__ == '__main__':
    print("\n" + "="*60)
    print("üöÄ OZON API ÊñáÊ°£ÊèêÂèñÂ∑•ÂÖ∑ÔºàHTMLÁâàÊú¨Ôºâ")
    print("="*60 + "\n")

    api_list = extract_all_apis()

    if api_list:
        generate_index(api_list)

    print("üéâ ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ\n")
    print("üí° ÊâìÂºÄ docs/OzonAPI/index.html Êü•ÁúãÊñáÊ°£Á¥¢Âºï\n")
